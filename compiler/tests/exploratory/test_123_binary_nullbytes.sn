// Test 123: Binary file with null bytes
// Tests handling of binary files containing null bytes (0x00)

fn main(): int =>
    print("Test binary file with null bytes:\n\n")
    var errors: int = 0

    // Test 1: Write and read file with null bytes
    print("Test 1 - Write and read null bytes:\n")
    var test_path: str = "/tmp/nullbytes_test.bin"
    // Pattern with null bytes: 0, 1, 0, 2, 0, 3, 0
    var data_with_nulls: byte[] = {0, 1, 0, 2, 0, 3, 0}
    BinaryFile.writeAll(test_path, data_with_nulls)

    var read_data: byte[] = BinaryFile.readAll(test_path)
    print($"  Written: {data_with_nulls.length} bytes\n")
    print($"  Read: {read_data.length} bytes\n")
    if read_data.length != 7 =>
        print("  FAIL: length mismatch\n")
        errors++

    // Verify each byte
    var i: int = 0
    shared for i in 0..7 =>
        if read_data[i] != data_with_nulls[i] =>
            print($"  FAIL: byte {i} mismatch\n")
            errors++

    print("  All bytes verified correctly\n")

    // Test 2: Null byte at start of file
    print("\nTest 2 - Null byte at file start:\n")
    var start_null: byte[] = {0, 65, 66, 67}  // null, A, B, C
    var start_path: str = "/tmp/start_null.bin"
    BinaryFile.writeAll(start_path, start_null)

    var read_start: byte[] = BinaryFile.readAll(start_path)
    if read_start.length != 4 =>
        print("  FAIL: wrong length\n")
        errors++
    if read_start[0] != 0 =>
        print("  FAIL: first byte should be 0\n")
        errors++
    if read_start[1] != 65 =>
        print("  FAIL: second byte should be 65 (A)\n")
        errors++
    print($"  Start null test passed, length: {read_start.length}\n")
    BinaryFile.delete(start_path)

    // Test 3: Null byte at end of file
    print("\nTest 3 - Null byte at file end:\n")
    var end_null: byte[] = {65, 66, 67, 0}  // A, B, C, null
    var end_path: str = "/tmp/end_null.bin"
    BinaryFile.writeAll(end_path, end_null)

    var read_end: byte[] = BinaryFile.readAll(end_path)
    if read_end.length != 4 =>
        print("  FAIL: wrong length\n")
        errors++
    if read_end[3] != 0 =>
        print("  FAIL: last byte should be 0\n")
        errors++
    print($"  End null test passed, length: {read_end.length}\n")
    BinaryFile.delete(end_path)

    // Test 4: All null bytes
    print("\nTest 4 - File of all null bytes:\n")
    var all_nulls: byte[] = {0, 0, 0, 0, 0}
    var all_path: str = "/tmp/all_nulls.bin"
    BinaryFile.writeAll(all_path, all_nulls)

    var read_all: byte[] = BinaryFile.readAll(all_path)
    if read_all.length != 5 =>
        print("  FAIL: wrong length\n")
        errors++

    var all_zeros: int = 1
    var j: int = 0
    shared for j in 0..5 =>
        if read_all[j] != 0 =>
            all_zeros = 0

    if all_zeros != 1 =>
        print("  FAIL: not all bytes are zero\n")
        errors++
    print($"  All nulls test passed, length: {read_all.length}\n")
    BinaryFile.delete(all_path)

    // Test 5: Instance readByte with null bytes
    print("\nTest 5 - readByte with null bytes:\n")
    var inst_path: str = "/tmp/inst_null.bin"
    var inst_data: byte[] = {0, 42, 0}
    BinaryFile.writeAll(inst_path, inst_data)

    var bf: BinaryFile = BinaryFile.open(inst_path)
    var b1: int = bf.readByte()
    var b2: int = bf.readByte()
    var b3: int = bf.readByte()
    var b4: int = bf.readByte()  // Should be EOF (-1)

    if b1 != 0 =>
        print($"  FAIL: first byte should be 0, got {b1}\n")
        errors++
    if b2 != 42 =>
        print($"  FAIL: second byte should be 42, got {b2}\n")
        errors++
    if b3 != 0 =>
        print($"  FAIL: third byte should be 0, got {b3}\n")
        errors++
    if b4 != -1 =>
        print($"  FAIL: fourth read should be -1 (EOF), got {b4}\n")
        errors++
    print($"  Instance readByte: b1={b1}, b2={b2}, b3={b3}, EOF={b4}\n")
    bf.close()
    BinaryFile.delete(inst_path)

    // Test 6: readBytes with nulls
    print("\nTest 6 - readBytes with nulls:\n")
    var bytes_path: str = "/tmp/bytes_null.bin"
    var bytes_data: byte[] = {0, 0, 255, 0, 0}
    BinaryFile.writeAll(bytes_path, bytes_data)

    var bf2: BinaryFile = BinaryFile.open(bytes_path)
    var chunk: byte[] = bf2.readBytes(5)
    if chunk.length != 5 =>
        print("  FAIL: wrong chunk length\n")
        errors++
    if chunk[2] != 255 =>
        print("  FAIL: middle byte should be 255\n")
        errors++
    print($"  readBytes: got {chunk.length} bytes, middle value: {chunk[2]}\n")
    bf2.close()
    BinaryFile.delete(bytes_path)

    // Test 7: Large file with many null bytes
    print("\nTest 7 - Large file with many nulls:\n")
    var large_path: str = "/tmp/large_nulls.bin"
    var large_data: byte[] = {}
    var k: int = 0
    shared for k in 0..100 =>
        large_data.push(0)
        large_data.push(255)

    BinaryFile.writeAll(large_path, large_data)
    var read_large: byte[] = BinaryFile.readAll(large_path)
    if read_large.length != 200 =>
        print($"  FAIL: expected 200 bytes, got {read_large.length}\n")
        errors++
    print($"  Large file: {read_large.length} bytes\n")
    BinaryFile.delete(large_path)

    // Cleanup original test file
    BinaryFile.delete(test_path)

    // Results
    if errors == 0 =>
        print("\nAll binary null byte tests PASSED!\n")
    if errors > 0 =>
        print($"\n{errors} tests FAILED!\n")

    return 0
