// Test 135: Very large file handling
// Tests file operations with large files

fn main(): int =>
    print("Test very large file handling:\n\n")
    var errors: int = 0
    var test_path: str = "/tmp/large_file_test.txt"
    var binary_path: str = "/tmp/large_binary_test.bin"

    // Test 1: Write and read large text file
    print("Test 1 - Large text file (10,000 lines):\n")
    var lines_to_write: int = 10000

    // Build content and write with writeAll
    var content: str = ""
    shared for i in 0..lines_to_write =>
        content = content + $"Line {i}: This is a test line with some content\n"
    TextFile.writeAll(test_path, content)
    print($"  Written {lines_to_write} lines\n")
    print($"  Content length: {content.length} chars\n")

    // Read and count lines
    var read_content: str = TextFile.readAll(test_path)
    var lines: str[] = read_content.split("\n")
    // Note: split may produce an extra empty element
    var read_lines: int = lines.length
    if lines[lines.length - 1] == "" =>
        read_lines = read_lines - 1
    print($"  Read back {read_lines} lines\n")

    if read_lines != lines_to_write =>
        print("  FAIL: line count mismatch\n")
        errors++

    // Test 2: Large binary file (100KB)
    print("\nTest 2 - Large binary file (100KB):\n")
    var bytes_to_write: int = 100000
    var large_data: byte[] = {}
    // Build a 100KB array in chunks
    shared for chunk in 0..1000 =>
        for b in 0..100 =>
            var byte_val: byte = (chunk + b) % 256
            large_data.push(byte_val)

    print($"  Created byte array of {large_data.length} bytes\n")
    BinaryFile.writeAll(binary_path, large_data)

    // Read back and verify
    var read_data: byte[] = BinaryFile.readAll(binary_path)
    print($"  Read back {read_data.length} bytes\n")

    if read_data.length != bytes_to_write =>
        print($"  FAIL: expected {bytes_to_write} bytes, got {read_data.length}\n")
        errors++

    // Verify some sample bytes
    var sample_checks: int = 0
    if read_data[0] == 0 => sample_checks++
    if read_data[100] == 100 => sample_checks++
    // At position 1000: chunk=10, b=0, so (10+0)%256 = 10
    if read_data[1000] == 10 => sample_checks++
    print($"  Sample byte checks passed: {sample_checks}/3\n")

    // Test 3: Large string in file
    print("\nTest 3 - Write very long string (10,000 chars):\n")
    var long_string: str = ""
    shared for i in 0..1000 =>
        long_string = long_string + "ABCDEFGHIJ"  // 10 chars * 1000 = 10000 chars

    print($"  String length: {long_string.length}\n")
    TextFile.writeAll("/tmp/long_string_test.txt", long_string)

    var read_long: str = TextFile.readAll("/tmp/long_string_test.txt")
    print($"  Read back length: {read_long.length}\n")

    if read_long.length != long_string.length =>
        print("  FAIL: length mismatch\n")
        errors++

    // Test 4: Large file line-by-line reading
    print("\nTest 4 - Read large file line-by-line:\n")
    var tf: TextFile = TextFile.open(test_path)
    var line_count: int = 0
    while tf.hasChars() =>
        var line: str = tf.readLine()
        line_count++
    tf.close()
    print($"  Read {line_count} lines with line-by-line method\n")

    // Test 5: Large binary file with instance methods
    print("\nTest 5 - Binary file byte-by-byte reading (first 100 bytes):\n")
    var bf: BinaryFile = BinaryFile.open(binary_path)
    var byte_count: int = 0
    var first_bytes_ok: int = 0
    for i in 0..100 =>
        var b: int = bf.readByte()
        if b != -1 =>
            byte_count++
            if b == i =>
                first_bytes_ok++
    bf.close()
    print($"  Read {byte_count} bytes, {first_bytes_ok} matched expected pattern\n")

    if first_bytes_ok != 100 =>
        print("  FAIL: byte pattern mismatch\n")
        errors++

    // Cleanup
    TextFile.delete(test_path)
    BinaryFile.delete(binary_path)
    TextFile.delete("/tmp/long_string_test.txt")

    // Results
    if errors == 0 =>
        print("\nAll large file tests PASSED!\n")
    if errors > 0 =>
        print($"\n{errors} tests FAILED!\n")

    return 0
