#!/bin/bash
# Run all exploratory tests and capture results

COMPILER="./bin/sn"
OUTPUT_DIR="./testing/output"

rm -rf "$OUTPUT_DIR" && mkdir -p "$OUTPUT_DIR"
echo "=== Sindarin Exploratory Test Results ==="
echo "Date: $(date)"
echo ""

for test_file in ./testing/test_*.sn; do
    test_name=$(basename "$test_file" .sn)
    exe_file="$OUTPUT_DIR/${test_name}"
    log_file="$OUTPUT_DIR/${test_name}.log"

    echo "Testing: $test_name"
    echo "========================================"
    echo "Test: $test_name"
    echo "========================================"

    # Compile .sn directly to executable
    compile_output=$(timeout 5s $COMPILER "$test_file" -o "$exe_file" -g 2>&1)
    compile_status=$?
    echo "Source: $test_file" 2>&1 > "$log_file"
    echo "$compile_output" 2>&1 >> "$log_file"

    if [ $compile_status -ne 0 ]; then
        echo "  COMPILE FAILED"
        echo "Status: COMPILE FAILED"
        echo "Output:"
        echo "$compile_output"
        echo ""
        continue
    fi

    # Run the executable
    run_output=$(timeout 30s "$exe_file" 2>&1)
    run_status=$?

    if [ $run_status -ne 0 ]; then
        echo "  RUNTIME ERROR (exit code: $run_status)"
        echo "Status: RUNTIME ERROR (exit: $run_status)"
        echo "Output:"
        echo "$run_output"
    else
        echo "  PASSED"
        echo "Status: PASSED"
    fi

    echo ""
done

echo ""
echo "Results written to $OUTPUT_DIR"
