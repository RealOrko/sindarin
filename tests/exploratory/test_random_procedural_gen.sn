// Exploratory test: Seeded procedural generation with Random
// Demonstrates using deterministic random sequences for world generation
// Key concept: Same seed always produces the same world

fn main(): int =>
    print("=== Seeded Procedural Generation ===\n\n")

    // Part 1: Generate a simple dungeon map
    test_dungeon_generation()

    // Part 2: Procedural terrain generation
    test_terrain_generation()

    // Part 3: Character/NPC generation
    test_character_generation()

    // Part 4: Loot table generation
    test_loot_generation()

    // Part 5: Verify reproducibility
    test_reproducibility()

    print("\n=== Procedural Generation Complete ===\n")
    return 0

// Generate a simple ASCII dungeon map
fn test_dungeon_generation(): void =>
    print("--- Dungeon Generation (Seed: 12345) ---\n\n")

    var rng: Random = Random.createWithSeed(12345l)
    var width: int = 40
    var height: int = 10

    // Initialize with walls
    var map: str = ""

    shared for y in 0..height =>
        shared for x in 0..width =>
            // Border walls
            if x == 0 || x == (width - 1) || y == 0 || y == (height - 1) =>
                map = map + "#"
            else =>
                // Random floor/wall based on probability
                var roll: int = rng.int(1, 100)
                if roll <= 75 =>
                    map = map + "."  // floor (75% chance)
                else =>
                    map = map + "#"  // wall (25% chance)
        map = map + "\n"

    print(map)

    // Add some features
    print("  Legend: # = wall, . = floor\n\n")

// Generate terrain with biomes
fn test_terrain_generation(): void =>
    print("--- Terrain Generation (Seed: 42) ---\n\n")

    var rng: Random = Random.createWithSeed(42l)
    var width: int = 50
    var height: int = 8

    var terrain: str = ""
    var biomes: str[] = {"~", ".", "^", "*", "#"}  // water, plains, mountains, forest, desert

    shared for y in 0..height =>
        shared for x in 0..width =>
            // Use weighted choice to create more realistic distribution
            var weights: double[] = {0.15, 0.35, 0.15, 0.25, 0.10}
            var tile: str = rng.weightedChoice(biomes, weights)
            terrain = terrain + tile
        terrain = terrain + "\n"

    print(terrain)
    print("  Legend: ~ = water, . = plains, ^ = mountains, * = forest, # = desert\n\n")

// Generate random characters/NPCs
fn test_character_generation(): void =>
    print("--- Character Generation (Seed: 99999) ---\n\n")

    var rng: Random = Random.createWithSeed(99999l)

    var first_names: str[] = {"Aldric", "Bran", "Cira", "Dara", "Elric", "Fiona", "Garin", "Helga"}
    var last_names: str[] = {"Ironforge", "Shadowmend", "Brightblade", "Darkwood", "Stormwind", "Fireborn"}
    var classes: str[] = {"Warrior", "Mage", "Rogue", "Cleric", "Ranger", "Bard"}
    var class_weights: double[] = {0.25, 0.15, 0.20, 0.15, 0.15, 0.10}

    print("  Generated Party:\n")
    for i in 0..4 =>
        var first: str = rng.choice(first_names)
        var last: str = rng.choice(last_names)
        var char_class: str = rng.weightedChoice(classes, class_weights)

        // Generate stats using 3d6 method
        var str_stat: int = rng.int(1, 6) + rng.int(1, 6) + rng.int(1, 6)
        var dex_stat: int = rng.int(1, 6) + rng.int(1, 6) + rng.int(1, 6)
        var con_stat: int = rng.int(1, 6) + rng.int(1, 6) + rng.int(1, 6)
        var int_stat: int = rng.int(1, 6) + rng.int(1, 6) + rng.int(1, 6)
        var wis_stat: int = rng.int(1, 6) + rng.int(1, 6) + rng.int(1, 6)
        var cha_stat: int = rng.int(1, 6) + rng.int(1, 6) + rng.int(1, 6)

        print($"    {i + 1}. {first} {last} - {char_class}\n")
        print($"       STR:{str_stat} DEX:{dex_stat} CON:{con_stat} INT:{int_stat} WIS:{wis_stat} CHA:{cha_stat}\n")

    print("\n")

// Generate loot drops with rarity tiers
fn test_loot_generation(): void =>
    print("--- Loot Generation (Seed: 77777) ---\n\n")

    var rng: Random = Random.createWithSeed(77777l)

    var rarity_tiers: str[] = {"Common", "Uncommon", "Rare", "Epic", "Legendary"}
    var rarity_weights: double[] = {0.50, 0.30, 0.15, 0.04, 0.01}

    var common_items: str[] = {"Rusty Sword", "Worn Leather", "Health Potion", "Bread"}
    var uncommon_items: str[] = {"Iron Sword", "Chainmail", "Mana Potion", "Lockpick"}
    var rare_items: str[] = {"Steel Blade", "Plate Armor", "Elixir", "Magic Scroll"}
    var epic_items: str[] = {"Enchanted Sword", "Dragon Scale", "Phoenix Down", "Grimoire"}
    var legendary_items: str[] = {"Excalibur", "Aegis Shield", "Philosopher's Stone", "Void Crystal"}

    print("  Loot from 10 chests:\n")
    for chest in 0..10 =>
        var rarity: str = rng.weightedChoice(rarity_tiers, rarity_weights)
        var item: str = "???"

        if rarity == "Common" => item = rng.choice(common_items)
        if rarity == "Uncommon" => item = rng.choice(uncommon_items)
        if rarity == "Rare" => item = rng.choice(rare_items)
        if rarity == "Epic" => item = rng.choice(epic_items)
        if rarity == "Legendary" => item = rng.choice(legendary_items)

        print($"    Chest {chest + 1}: [{rarity}] {item}\n")

    print("\n")

// Verify that same seed produces identical results
fn test_reproducibility(): void =>
    print("--- Reproducibility Verification ---\n\n")

    print("  Generating world with seed 54321 (first time):\n")
    var world1: str = generate_mini_world(54321l)
    print(world1)

    print("  Generating world with seed 54321 (second time):\n")
    var world2: str = generate_mini_world(54321l)
    print(world2)

    // Verify they match
    if world1 == world2 =>
        print("  PASS: Identical worlds generated from same seed!\n")
    else =>
        print("  FAIL: Worlds differ despite same seed\n")

    print("\n  Generating world with different seed 54322:\n")
    var world3: str = generate_mini_world(54322l)
    print(world3)

    if world3 != world1 =>
        print("  PASS: Different seed produces different world!\n")
    else =>
        print("  FAIL: Different seeds produced same world (unlikely)\n")

// Helper function to generate a small reproducible world
fn generate_mini_world(seed: long): str =>
    var rng: Random = Random.createWithSeed(seed)
    var result: str = "    "

    shared for y in 0..5 =>
        shared for x in 0..20 =>
            var tiles: str[] = {".", ".", ".", "^", "~", "*"}
            result = result + rng.choice(tiles)
        result = result + "\n    "

    return result
