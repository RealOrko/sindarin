// Test Environment type conversion error handling
// These tests verify that invalid type conversions produce proper error messages
// by spawning child processes (since invalid conversions exit the program)
//
// NOTE: These tests compile small test programs and run them to verify
// that the runtime correctly rejects invalid type conversions.
// The test programs must USE the variable to prevent dead code elimination.
//
// Cross-platform: works on Windows and Linux

fn main(): int =>
    print("=== Environment Invalid Type Conversion Tests ===\n")
    var errors: int = 0

    // Get cross-platform temp directory
    var tempDir: str = Environment.get("TEMP", Environment.get("TMPDIR", "/tmp")).replace("\\", "/")
    var testDir: str = $"{tempDir}/sn_env_tests"

    // Determine executable extension and compiler path (must be absolute for Process.run)
    var exeExt: str = ""
    var snCompiler: str = Path.absolute("bin/sn")
    if Environment.get("OS", "").contains("Windows") =>
        exeExt = ".exe"
        snCompiler = Path.absolute("bin/sn.exe")
        // Ensure LLVM is in PATH for child compiler processes on Windows
        var currentPath: str = Environment.get("PATH", "")
        if !currentPath.contains("LLVM") =>
            Environment.set("PATH", $"C:/Program Files/LLVM/bin;{currentPath}")

    // Create test directory
    Directory.create(testDir)

    // ============================================================
    // INVALID INTEGER CONVERSION
    // ============================================================
    print("\n--- Invalid Integer Conversion ---\n")

    // Test 1: Invalid integer should cause error
    print("Test 1 - Invalid integer causes error:\n")

    // Write a test program that tries to parse an invalid integer
    // NOTE: Must print x to prevent dead code elimination
    var code1: str = "fn main(): int =>\n    Environment.set(\"TEST_INVALID_INT\", \"not_a_number\")\n    var x: int = Environment.getInt(\"TEST_INVALID_INT\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_invalid_int.sn", code1)

    // Compile and run
    var compileProc1: Process = Process.run(snCompiler, {$"{testDir}/test_invalid_int.sn", "-o", $"{testDir}/test_invalid_int"})
    if compileProc1.exitCode == 0 =>
        var runProc1: Process = Process.run($"{testDir}/test_invalid_int{exeExt}", {})
        if runProc1.exitCode != 0 =>
            print("  PASS: Invalid integer causes runtime error\n")
        else =>
            print("  FAIL: Invalid integer should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // Test 2: Integer with trailing garbage
    print("\nTest 2 - Integer with trailing text causes error:\n")

    var code2: str = "fn main(): int =>\n    Environment.set(\"TEST_TRAILING_INT\", \"42abc\")\n    var x: int = Environment.getInt(\"TEST_TRAILING_INT\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_trailing_int.sn", code2)

    var compileProc2: Process = Process.run(snCompiler, {$"{testDir}/test_trailing_int.sn", "-o", $"{testDir}/test_trailing_int"})
    if compileProc2.exitCode == 0 =>
        var runProc2: Process = Process.run($"{testDir}/test_trailing_int{exeExt}", {})
        if runProc2.exitCode != 0 =>
            print("  PASS: Integer with trailing text causes error\n")
        else =>
            print("  FAIL: Integer with trailing text should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // ============================================================
    // INVALID DOUBLE CONVERSION
    // ============================================================
    print("\n--- Invalid Double Conversion ---\n")

    // Test 3: Invalid double should cause error
    print("Test 3 - Invalid double causes error:\n")

    var code3: str = "fn main(): int =>\n    Environment.set(\"TEST_INVALID_DOUBLE\", \"not_a_double\")\n    var x: double = Environment.getDouble(\"TEST_INVALID_DOUBLE\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_invalid_double.sn", code3)

    var compileProc3: Process = Process.run(snCompiler, {$"{testDir}/test_invalid_double.sn", "-o", $"{testDir}/test_invalid_double"})
    if compileProc3.exitCode == 0 =>
        var runProc3: Process = Process.run($"{testDir}/test_invalid_double{exeExt}", {})
        if runProc3.exitCode != 0 =>
            print("  PASS: Invalid double causes runtime error\n")
        else =>
            print("  FAIL: Invalid double should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // Test 4: Double with multiple decimal points
    print("\nTest 4 - Double with multiple decimal points:\n")

    var code4: str = "fn main(): int =>\n    Environment.set(\"TEST_MULTI_DECIMAL\", \"3.14.159\")\n    var x: double = Environment.getDouble(\"TEST_MULTI_DECIMAL\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_multi_decimal.sn", code4)

    var compileProc4: Process = Process.run(snCompiler, {$"{testDir}/test_multi_decimal.sn", "-o", $"{testDir}/test_multi_decimal"})
    if compileProc4.exitCode == 0 =>
        var runProc4: Process = Process.run($"{testDir}/test_multi_decimal{exeExt}", {})
        if runProc4.exitCode != 0 =>
            print("  PASS: Double with multiple decimals causes error\n")
        else =>
            print("  FAIL: Double with multiple decimals should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // ============================================================
    // INVALID LONG CONVERSION
    // ============================================================
    print("\n--- Invalid Long Conversion ---\n")

    // Test 5: Invalid long should cause error
    print("Test 5 - Invalid long causes error:\n")

    var code5: str = "fn main(): int =>\n    Environment.set(\"TEST_INVALID_LONG\", \"not_a_long\")\n    var x: long = Environment.getLong(\"TEST_INVALID_LONG\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_invalid_long.sn", code5)

    var compileProc5: Process = Process.run(snCompiler, {$"{testDir}/test_invalid_long.sn", "-o", $"{testDir}/test_invalid_long"})
    if compileProc5.exitCode == 0 =>
        var runProc5: Process = Process.run($"{testDir}/test_invalid_long{exeExt}", {})
        if runProc5.exitCode != 0 =>
            print("  PASS: Invalid long causes runtime error\n")
        else =>
            print("  FAIL: Invalid long should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // Test 6: Long overflow (too large number)
    print("\nTest 6 - Long overflow:\n")

    var code6: str = "fn main(): int =>\n    Environment.set(\"TEST_OVERFLOW_LONG\", \"99999999999999999999999999999999\")\n    var x: long = Environment.getLong(\"TEST_OVERFLOW_LONG\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_overflow_long.sn", code6)

    var compileProc6: Process = Process.run(snCompiler, {$"{testDir}/test_overflow_long.sn", "-o", $"{testDir}/test_overflow_long"})
    if compileProc6.exitCode == 0 =>
        var runProc6: Process = Process.run($"{testDir}/test_overflow_long{exeExt}", {})
        if runProc6.exitCode != 0 =>
            print("  PASS: Long overflow causes runtime error\n")
        else =>
            print("  FAIL: Long overflow should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // ============================================================
    // INVALID BOOLEAN CONVERSION
    // ============================================================
    print("\n--- Invalid Boolean Conversion ---\n")

    // Test 7: Invalid boolean should cause error
    print("Test 7 - Invalid boolean ('maybe') causes error:\n")

    var code7: str = "fn main(): int =>\n    Environment.set(\"TEST_INVALID_BOOL\", \"maybe\")\n    var x: bool = Environment.getBool(\"TEST_INVALID_BOOL\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_invalid_bool.sn", code7)

    var compileProc7: Process = Process.run(snCompiler, {$"{testDir}/test_invalid_bool.sn", "-o", $"{testDir}/test_invalid_bool"})
    if compileProc7.exitCode == 0 =>
        var runProc7: Process = Process.run($"{testDir}/test_invalid_bool{exeExt}", {})
        if runProc7.exitCode != 0 =>
            print("  PASS: Invalid boolean ('maybe') causes error\n")
        else =>
            print("  FAIL: Invalid boolean should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // Test 8: Number > 1 is invalid boolean
    print("\nTest 8 - Number > 1 is invalid boolean:\n")

    var code8: str = "fn main(): int =>\n    Environment.set(\"TEST_BOOL_NUM2\", \"2\")\n    var x: bool = Environment.getBool(\"TEST_BOOL_NUM2\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_bool_number2.sn", code8)

    var compileProc8: Process = Process.run(snCompiler, {$"{testDir}/test_bool_number2.sn", "-o", $"{testDir}/test_bool_number2"})
    if compileProc8.exitCode == 0 =>
        var runProc8: Process = Process.run($"{testDir}/test_bool_number2{exeExt}", {})
        if runProc8.exitCode != 0 =>
            print("  PASS: '2' as boolean causes error\n")
        else =>
            print("  FAIL: '2' as boolean should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // ============================================================
    // DEFAULT VALUE DOESN'T MASK INVALID VALUES
    // ============================================================
    print("\n--- Default Value with Invalid Conversion ---\n")

    // Test 9: Invalid int with default should still error
    print("Test 9 - Invalid int with default still errors:\n")

    var code9: str = "fn main(): int =>\n    Environment.set(\"TEST_INVALID_INT_DEF\", \"xyz\")\n    var x: int = Environment.getInt(\"TEST_INVALID_INT_DEF\", 100)\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_invalid_int_default.sn", code9)

    var compileProc9: Process = Process.run(snCompiler, {$"{testDir}/test_invalid_int_default.sn", "-o", $"{testDir}/test_invalid_int_default"})
    if compileProc9.exitCode == 0 =>
        var runProc9: Process = Process.run($"{testDir}/test_invalid_int_default{exeExt}", {})
        if runProc9.exitCode != 0 =>
            print("  PASS: Invalid int with default causes error (default only for unset)\n")
        else =>
            print("  FAIL: Invalid int with default should still cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // Test 10: Invalid bool with default should still error
    print("\nTest 10 - Invalid bool with default still errors:\n")

    var code10: str = "fn main(): int =>\n    Environment.set(\"TEST_INVALID_BOOL_DEF\", \"invalid\")\n    var x: bool = Environment.getBool(\"TEST_INVALID_BOOL_DEF\", true)\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_invalid_bool_default.sn", code10)

    var compileProc10: Process = Process.run(snCompiler, {$"{testDir}/test_invalid_bool_default.sn", "-o", $"{testDir}/test_invalid_bool_default"})
    if compileProc10.exitCode == 0 =>
        var runProc10: Process = Process.run($"{testDir}/test_invalid_bool_default{exeExt}", {})
        if runProc10.exitCode != 0 =>
            print("  PASS: Invalid bool with default causes error (default only for unset)\n")
        else =>
            print("  FAIL: Invalid bool with default should still cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // ============================================================
    // REQUIRED VARIABLE NOT SET
    // ============================================================
    print("\n--- Required Variable Not Set ---\n")

    // Test 11: Get without default for unset variable
    // NOTE: Current implementation returns NULL for unset variables.
    // This test documents current behavior - returns NULL for unset.
    print("Test 11 - Get without default for unset variable:\n")

    var code11: str = "fn main(): int =>\n    Environment.remove(\"TEST_REQUIRED_UNSET\")\n    var x: str = Environment.get(\"TEST_REQUIRED_UNSET\")\n    print(x)\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_required_unset.sn", code11)

    var compileProc11: Process = Process.run(snCompiler, {$"{testDir}/test_required_unset.sn", "-o", $"{testDir}/test_required_unset"})
    if compileProc11.exitCode == 0 =>
        var runProc11: Process = Process.run($"{testDir}/test_required_unset{exeExt}", {})
        // Current behavior: returns NULL/prints "(null)", doesn't throw
        if runProc11.exitCode == 0 =>
            print("  INFO: Get without default for unset returns NULL (current behavior)\n")
        else =>
            print("  PASS: Get without default for unset now throws error\n")
    else =>
        print($"  SKIP: Compilation failed\n")

    // Test 12: getInt without default for unset variable
    print("\nTest 12 - getInt without default for unset variable:\n")

    var code12: str = "fn main(): int =>\n    Environment.remove(\"TEST_REQUIRED_INT_UNSET\")\n    var x: int = Environment.getInt(\"TEST_REQUIRED_INT_UNSET\")\n    print($\"{x}\")\n    return 0\n"
    TextFile.writeAll($"{testDir}/test_required_int_unset.sn", code12)

    var compileProc12: Process = Process.run(snCompiler, {$"{testDir}/test_required_int_unset.sn", "-o", $"{testDir}/test_required_int_unset"})
    if compileProc12.exitCode == 0 =>
        var runProc12: Process = Process.run($"{testDir}/test_required_int_unset{exeExt}", {})
        if runProc12.exitCode != 0 =>
            print("  PASS: getInt without default for unset variable causes error\n")
        else =>
            print("  FAIL: getInt without default for unset variable should cause error\n")
            errors++
    else =>
        print($"  SKIP: Compilation failed\n")

    // ============================================================
    // CLEANUP
    // ============================================================
    if Path.isDirectory(testDir) =>
        Directory.deleteRecursive(testDir)

    // ============================================================
    // RESULTS SUMMARY
    // ============================================================
    print("\n=== Test Summary ===\n")
    if errors == 0 =>
        print("All Environment invalid type conversion tests PASSED!\n")
    else =>
        print($"{errors} tests FAILED!\n")

    return errors
