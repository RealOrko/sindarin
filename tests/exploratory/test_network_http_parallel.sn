// Test: Parallel HTTP-like requests
// Demonstrates making multiple HTTP-style requests concurrently

fn handleHttpRequest(client: TcpStream, responsePath: str): void =>
    // Read the request (we don't parse it, just consume it)
    client.read(1024)
    // Send HTTP response
    client.write($"HTTP/1.0 200 OK\r\n\r\n{responsePath}".toBytes())
    client.close()

fn runServer(listener: TcpListener): int =>
    // Accept and handle 3 HTTP connections
    var c1: TcpStream = listener.accept()
    handleHttpRequest(c1, "/page1")

    var c2: TcpStream = listener.accept()
    handleHttpRequest(c2, "/page2")

    var c3: TcpStream = listener.accept()
    handleHttpRequest(c3, "/page3")

    return 0

fn httpGet(addr: str, path: str): str =>
    var conn: TcpStream = TcpStream.connect(addr)
    conn.writeLine($"GET {path} HTTP/1.0")
    conn.writeLine("Host: localhost")
    conn.writeLine("")
    var response: byte[] = conn.read(4096)
    conn.close()
    return response.toString()

fn main(): void =>
    print("Testing parallel HTTP-like requests\n")

    // Create server on OS-assigned port
    var listener: TcpListener = TcpListener.bind("127.0.0.1:0")
    var port: int = listener.port
    var addr: str = $"127.0.0.1:{port}"

    // Start server in background thread
    var serverThread: int = &runServer(listener)

    // Delay to ensure server is accepting
    Time.sleep(100)

    print("Server ready\n")

    // Make 3 parallel HTTP GET requests to different paths
    var resp1: str = &httpGet(addr, "/page1")
    var resp2: str = &httpGet(addr, "/page2")
    var resp3: str = &httpGet(addr, "/page3")

    // Sync all requests
    resp1!
    resp2!
    resp3!
    print("All HTTP requests completed in parallel\n")

    // Verify responses contain expected paths
    var count: int = 0
    if resp1.contains("/page") =>
        count = count + 1
    if resp2.contains("/page") =>
        count = count + 1
    if resp3.contains("/page") =>
        count = count + 1

    print($"Valid responses: {count}\n")

    if count == 3 =>
        print("SUCCESS: All parallel HTTP requests returned valid responses\n")
    else =>
        print("FAILURE: Some HTTP requests failed\n")

    // Wait for server to finish
    serverThread!

    listener.close()
    print("Test complete\n")
