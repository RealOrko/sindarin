// Test 146: Time common patterns

// Test work function for benchmarking
fn testWork(): void =>
    var j: int = 0
    var sum: int = 0
    while j < 1000 =>
        sum = sum + j
        j = j + 1

// Benchmark helper function - measures time for iterations
// ISSUE: Function pointer parameter causes SEGV crash at runtime
// Workaround: Use direct function call in specific helper
fn benchmark(name: str, iterations: int, f: fn(): void): void =>
    print($"  Benchmarking {name}...\n")
    var start: Time = Time.now()

    var i: int = 0
    while i < iterations =>
        f()
        i = i + 1

    var elapsed: int = Time.now().diff(start)
    var perOp: int = elapsed * 1000 / iterations
    print($"    Total: {elapsed}ms for {iterations} iterations\n")
    print($"    Per-op: {perOp}us (microseconds)\n")

// Working benchmark helper using direct call
fn benchmarkTestWork(name: str, iterations: int): void =>
    print($"  Benchmarking {name}...\n")
    var start: Time = Time.now()

    var i: int = 0
    while i < iterations =>
        testWork()
        i = i + 1

    var elapsed: int = Time.now().diff(start)
    var perOp: int = elapsed * 1000 / iterations
    print($"    Total: {elapsed}ms for {iterations} iterations\n")
    print($"    Per-op: {perOp}us (microseconds)\n")

// Format duration in milliseconds to human-readable string
fn formatDuration(ms: int): str =>
    var hours: int = ms / 3600000
    var minutes: int = (ms / 60000) % 60
    var seconds: int = (ms / 1000) % 60
    var millis: int = ms % 1000

    if hours > 0 =>
        return $"{hours}h {minutes}m {seconds}s"
    else =>
        if minutes > 0 =>
            return $"{minutes}m {seconds}s"
        else =>
            if seconds > 0 =>
                return $"{seconds}.{millis}s"
            else =>
                return $"{millis}ms"

fn main(): int =>
    print("Testing Time common patterns...\n")
    print("===============================\n\n")

    // Simple stopwatch pattern
    print("Simple stopwatch pattern:\n")
    print("  Starting work (loop 1M times)...\n")

    var start: Time = Time.now()

    // Do some work - loop 1 million times
    var i: int = 0
    var sum: int = 0
    while i < 1000000 =>
        sum = sum + i
        i = i + 1

    var elapsed: int = Time.now().diff(start)
    print($"  Work completed in {elapsed}ms\n")
    print($"  Sum result: {sum}\n")

    print("\nStopwatch pattern - PASS\n")

    // Benchmarking pattern using helper function
    // Note: Using direct call version due to function pointer issue
    print("\nBenchmarking pattern:\n")
    benchmarkTestWork("testWork (1000 loops)", 1000)

    print("\nBenchmark pattern - PASS\n")

    // Timeout loop pattern
    print("\nTimeout loop pattern:\n")
    var timeout: int = 100  // 100ms timeout for demo (not 5 seconds for quick test)
    var loopStart: Time = Time.now()
    var iterations: int = 0
    var done: bool = false

    while Time.now().diff(loopStart) < timeout =>
        if done =>
            // Break condition met
            iterations = iterations
        else =>
            iterations = iterations + 1
            // Simulate work
            if iterations > 50 =>
                done = true

    var loopElapsed: int = Time.now().diff(loopStart)
    print($"  Timeout loop ran {iterations} iterations in {loopElapsed}ms\n")
    print($"  Loop exited via: {done} (true=break condition, false=timeout)\n")

    print("\nTimeout loop pattern - PASS\n")

    // Formatting dates pattern
    print("\nFormatting dates pattern:\n")
    var now: Time = Time.now()

    // Common date formats
    print("  Common formats:\n")
    print($"    YYYY-MM-DD HH:mm:ss: {now.format("YYYY-MM-DD HH:mm:ss")}\n")
    print($"    M/D/YYYY: {now.format("M/D/YYYY")}\n")
    print($"    h:mm A: {now.format("h:mm A")}\n")

    // Log timestamp pattern
    print("\n  Log timestamp pattern:\n")
    print($"    [{now.format("YYYY-MM-DD HH:mm:ss")}] Event occurred\n")

    // Filename pattern
    print("\n  Filename pattern:\n")
    print($"    backup_{now.format("YYYYMMDD_HHmmss")}.txt\n")

    print("\nFormatting dates pattern - PASS\n")

    // Duration calculation pattern
    print("\nDuration calculation pattern:\n")

    // Test formatDuration with sample values
    print("  Sample durations:\n")
    print($"    500ms -> {formatDuration(500)}\n")
    print($"    5000ms -> {formatDuration(5000)}\n")
    print($"    65000ms -> {formatDuration(65000)}\n")
    print($"    7265000ms -> {formatDuration(7265000)}\n")

    // Practical usage: simulate work and format elapsed time
    print("\n  Practical usage:\n")
    var workStart: Time = Time.now()
    var k: int = 0
    var workSum: int = 0
    while k < 500000 =>
        workSum = workSum + k
        k = k + 1
    var workElapsed: int = Time.now().diff(workStart)
    print($"    Work completed in: {formatDuration(workElapsed)}\n")

    print("\nDuration calculation pattern - PASS\n")

    // Scheduling future events pattern
    print("\nScheduling future events pattern:\n")
    var eventTime: Time = now.addHours(2).addMinutes(30)
    print($"  Current time: {now.format("h:mm A")}\n")
    print($"  Event scheduled for: {eventTime.format("h:mm A")}\n")

    var waitMs: int = eventTime.diff(now)
    var waitMinutes: int = waitMs / 1000 / 60
    print($"  Time until event: {waitMinutes} minutes\n")

    print("\nScheduling pattern - PASS\n")

    // Date comparison pattern
    print("\nDate comparison pattern:\n")
    var deadline: Time = Time.fromSeconds(1735689600)
    print($"  Deadline: {deadline.format("YYYY-MM-DD")}\n")
    print($"  Current:  {now.format("YYYY-MM-DD")}\n")

    if now.isBefore(deadline) =>
        var remainingMs: int = deadline.diff(now)
        var remainingDays: int = remainingMs / 1000 / 60 / 60 / 24
        print($"  Days until deadline: {remainingDays}\n")
    else =>
        print("  Deadline has passed!\n")

    print("\nDate comparison pattern - PASS\n")

    print("\n===============================\n")
    print("All 7 patterns complete - PASS\n")

    return 0
