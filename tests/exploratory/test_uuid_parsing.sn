// Test UUID parsing - comprehensive parsing tests
// Tests valid formats and documents malformed UUID behavior

fn main(): int =>
    print("=== UUID Parsing Tests ===\n")
    var errors: int = 0

    // ============================================================
    // STANDARD FORMAT PARSING (36 chars with dashes)
    // ============================================================
    print("\n--- Standard Format Parsing ---\n")

    // Test 1: Valid standard format
    print("Test 1 - Valid standard format:\n")
    var valid: UUID = UUID.fromString("01234567-89ab-cdef-0123-456789abcdef")
    var validStr: str = valid.toString()
    if validStr == "01234567-89ab-cdef-0123-456789abcdef" =>
        print("  PASS: Valid format parsed correctly\n")
    else =>
        print($"  FAIL: Expected original, got {validStr}\n")
        errors++

    // Test 2: All zeros
    print("\nTest 2 - All zeros:\n")
    var zeros: UUID = UUID.fromString("00000000-0000-0000-0000-000000000000")
    if zeros.isNil() =>
        print("  PASS: All zeros parses as nil UUID\n")
    else =>
        print("  FAIL: All zeros should be nil\n")
        errors++

    // Test 3: All ones (f's)
    print("\nTest 3 - All f's:\n")
    var maxFs: UUID = UUID.fromString("ffffffff-ffff-ffff-ffff-ffffffffffff")
    var maxUuid: UUID = UUID.max()
    if maxFs.equals(maxUuid) =>
        print("  PASS: All f's parses as max UUID\n")
    else =>
        print("  FAIL: All f's should equal max UUID\n")
        errors++

    // Test 4: Mixed case - should normalize to lowercase
    print("\nTest 4 - Uppercase hex:\n")
    var upper: UUID = UUID.fromString("ABCDEF01-2345-6789-ABCD-EF0123456789")
    var upperStr: str = upper.toString()
    if upperStr == "abcdef01-2345-6789-abcd-ef0123456789" =>
        print("  PASS: Uppercase normalized to lowercase\n")
    else =>
        print($"  FAIL: Expected lowercase, got {upperStr}\n")
        errors++

    // Test 5: Mixed case
    print("\nTest 5 - Mixed case:\n")
    var mixed: UUID = UUID.fromString("AbCdEf01-2345-6789-aBcD-Ef0123456789")
    var mixedStr: str = mixed.toString()
    if mixedStr == "abcdef01-2345-6789-abcd-ef0123456789" =>
        print("  PASS: Mixed case normalized correctly\n")
    else =>
        print($"  FAIL: Expected lowercase, got {mixedStr}\n")
        errors++

    // Test 6: Known v4 UUID
    print("\nTest 6 - Known v4 UUID format:\n")
    var v4: UUID = UUID.fromString("f47ac10b-58cc-4372-a567-0e02b2c3d479")
    if v4.version() == 4 =>
        print("  PASS: v4 UUID parsed with correct version\n")
    else =>
        print($"  FAIL: Expected version 4, got {v4.version()}\n")
        errors++

    // Test 7: Known v7 UUID
    print("\nTest 7 - Known v7 UUID format:\n")
    var v7: UUID = UUID.fromString("01912345-6789-7abc-8def-0123456789ab")
    if v7.version() == 7 =>
        print("  PASS: v7 UUID parsed with correct version\n")
    else =>
        print($"  FAIL: Expected version 7, got {v7.version()}\n")
        errors++

    // ============================================================
    // HEX FORMAT PARSING (32 chars, no dashes)
    // ============================================================
    print("\n--- Hex Format Parsing ---\n")

    // Test 8: Valid hex format
    print("Test 8 - Valid hex format:\n")
    var hex: UUID = UUID.fromHex("0123456789abcdef0123456789abcdef")
    var hexStr: str = hex.toString()
    if hexStr == "01234567-89ab-cdef-0123-456789abcdef" =>
        print("  PASS: Hex format parsed correctly\n")
    else =>
        print($"  FAIL: Expected standard format, got {hexStr}\n")
        errors++

    // Test 9: Hex all zeros
    print("\nTest 9 - Hex all zeros:\n")
    var hexZero: UUID = UUID.fromHex("00000000000000000000000000000000")
    if hexZero.isNil() =>
        print("  PASS: Hex all zeros is nil\n")
    else =>
        print("  FAIL: Hex all zeros should be nil\n")
        errors++

    // Test 10: Hex uppercase
    print("\nTest 10 - Hex uppercase:\n")
    var hexUpper: UUID = UUID.fromHex("ABCDEF0123456789ABCDEF0123456789")
    var hexUpperStr: str = hexUpper.toString()
    if hexUpperStr == "abcdef01-2345-6789-abcd-ef0123456789" =>
        print("  PASS: Hex uppercase normalized\n")
    else =>
        print($"  FAIL: Expected lowercase, got {hexUpperStr}\n")
        errors++

    // ============================================================
    // BASE64 FORMAT PARSING (22 chars)
    // ============================================================
    print("\n--- Base64 Format Parsing ---\n")

    // Test 11: Round-trip base64
    print("Test 11 - Base64 round-trip:\n")
    var original: UUID = UUID.v7()
    var b64: str = original.toBase64()
    var fromB64: UUID = UUID.fromBase64(b64)
    if original.equals(fromB64) =>
        print("  PASS: Base64 round-trip preserves UUID\n")
    else =>
        print("  FAIL: Base64 round-trip failed\n")
        errors++

    // Test 12: Base64 nil UUID
    print("\nTest 12 - Base64 nil UUID:\n")
    var nilUuid: UUID = UUID.zero()
    var nilB64: str = nilUuid.toBase64()
    var nilFromB64: UUID = UUID.fromBase64(nilB64)
    if nilFromB64.isNil() =>
        print("  PASS: Base64 nil round-trip works\n")
    else =>
        print("  FAIL: Base64 nil round-trip failed\n")
        errors++

    // Test 13: Base64 max UUID
    print("\nTest 13 - Base64 max UUID:\n")
    var maxOriginal: UUID = UUID.max()
    var maxB64: str = maxOriginal.toBase64()
    var maxFromB64: UUID = UUID.fromBase64(maxB64)
    if maxFromB64.equals(maxOriginal) =>
        print("  PASS: Base64 max round-trip works\n")
    else =>
        print("  FAIL: Base64 max round-trip failed\n")
        errors++

    // ============================================================
    // NAMESPACE UUID PARSING
    // ============================================================
    print("\n--- Namespace UUID Values ---\n")

    // Test 14: DNS namespace
    print("Test 14 - DNS namespace value:\n")
    var nsDns: UUID = UUID.namespaceDns()
    if nsDns.toString() == "6ba7b810-9dad-11d1-80b4-00c04fd430c8" =>
        print("  PASS: DNS namespace correct\n")
    else =>
        print($"  FAIL: DNS namespace is {nsDns.toString()}\n")
        errors++

    // Test 15: URL namespace
    print("\nTest 15 - URL namespace value:\n")
    var nsUrl: UUID = UUID.namespaceUrl()
    if nsUrl.toString() == "6ba7b811-9dad-11d1-80b4-00c04fd430c8" =>
        print("  PASS: URL namespace correct\n")
    else =>
        print($"  FAIL: URL namespace is {nsUrl.toString()}\n")
        errors++

    // Test 16: OID namespace
    print("\nTest 16 - OID namespace value:\n")
    var nsOid: UUID = UUID.namespaceOid()
    if nsOid.toString() == "6ba7b812-9dad-11d1-80b4-00c04fd430c8" =>
        print("  PASS: OID namespace correct\n")
    else =>
        print($"  FAIL: OID namespace is {nsOid.toString()}\n")
        errors++

    // Test 17: X500 namespace
    print("\nTest 17 - X500 namespace value:\n")
    var nsX500: UUID = UUID.namespaceX500()
    if nsX500.toString() == "6ba7b814-9dad-11d1-80b4-00c04fd430c8" =>
        print("  PASS: X500 namespace correct\n")
    else =>
        print($"  FAIL: X500 namespace is {nsX500.toString()}\n")
        errors++

    // ============================================================
    // MALFORMED UUID DOCUMENTATION
    // ============================================================
    print("\n--- Malformed UUID Behavior (Documented) ---\n")

    print("The following malformed inputs cause runtime errors:\n")
    print("  - Wrong length: too short or too long strings\n")
    print("  - Missing dashes at positions 8, 13, 18, 23\n")
    print("  - Invalid hex characters (g-z, special chars)\n")
    print("  - Invalid base64 characters\n")
    print("  - Wrong base64 length (not 22 chars)\n")
    print("\n")
    print("These are intentionally runtime errors to catch bugs early.\n")
    print("Programs should validate input before parsing if recovery is needed.\n")

    // ============================================================
    // FORMAT PRESERVATION
    // ============================================================
    print("\n--- Format Preservation ---\n")

    // Test 18: All formats produce same UUID
    print("Test 18 - All formats represent same UUID:\n")
    var testUuid: UUID = UUID.v7()
    var stdStr: str = testUuid.toString()
    var hexFmt: str = testUuid.toHex()
    var b64Fmt: str = testUuid.toBase64()

    var fromStd: UUID = UUID.fromString(stdStr)
    var fromHex2: UUID = UUID.fromHex(hexFmt)
    var fromB642: UUID = UUID.fromBase64(b64Fmt)

    var allSame: bool = true
    if !testUuid.equals(fromStd) =>
        print("  FAIL: fromString differs\n")
        allSame = false
    if !testUuid.equals(fromHex2) =>
        print("  FAIL: fromHex differs\n")
        allSame = false
    if !testUuid.equals(fromB642) =>
        print("  FAIL: fromBase64 differs\n")
        allSame = false

    if allSame =>
        print("  PASS: All formats preserve UUID identity\n")
    else =>
        errors++

    // ============================================================
    // TIMESTAMP EXTRACTION ERROR DOCUMENTATION
    // ============================================================
    print("\n--- Timestamp Extraction Error (Documented) ---\n")
    print("Calling timestamp() on non-v7 UUIDs causes a runtime error.\n")
    print("This is by design per the UUID.md specification.\n")
    print("\n")
    print("Safe pattern for unknown UUIDs:\n")
    print("  if uuid.version() == 7 =>\n")
    print("      var ts: long = uuid.timestamp()\n")
    print("\n")

    // Verify the safe pattern works
    print("Test: Safe pattern with v7 UUID:\n")
    var safeV7: UUID = UUID.v7()
    if safeV7.version() == 7 =>
        var safeTs: long = safeV7.timestamp()
        if safeTs > 0l =>
            print("  PASS: Safe pattern extracts timestamp\n")
        else =>
            print($"  FAIL: Timestamp should be positive, got {safeTs}\n")
            errors++
    else =>
        print("  FAIL: Generated v7 should have version 7\n")
        errors++

    print("\nTest: Safe pattern with v4 UUID (skip timestamp):\n")
    var safeV4: UUID = UUID.v4()
    if safeV4.version() == 7 =>
        // Won't enter this branch
        print("  FAIL: v4 should not have version 7\n")
        errors++
    else =>
        print("  PASS: Correctly skipped timestamp extraction for v4\n")

    // ============================================================
    // SUMMARY
    // ============================================================
    print("\n=== Test Summary ===\n")
    if errors == 0 =>
        print("All UUID parsing tests PASSED!\n")
    else =>
        print($"{errors} tests FAILED!\n")

    return errors
