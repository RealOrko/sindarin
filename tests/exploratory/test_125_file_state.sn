// Test 125: File state and handle operations
// Tests file state management, EOF detection, and proper cleanup

fn main(): int =>
    print("Test file state and handle operations:\n\n")
    var errors: int = 0

    // Test 1: File state transitions
    print("Test 1 - File state transitions:\n")
    var state_path: str = "/tmp/state_test.txt"
    TextFile.writeAll(state_path, "line1\nline2\nline3")

    var f1: TextFile = TextFile.open(state_path)
    var first_line: str = f1.readLine()
    print($"  After first readLine: {first_line}\n")

    var remaining: str = f1.readAll()
    print($"  Remaining content length: {remaining.length}\n")
    f1.close()

    // Test 2: hasChars state tracking
    print("\nTest 2 - hasChars state tracking:\n")
    TextFile.writeAll(state_path, "ABC")
    var f2: TextFile = TextFile.open(state_path)

    var ch1: int = f2.readChar()
    var ch2: int = f2.readChar()
    var ch3: int = f2.readChar()
    print($"  Read chars: {ch1}, {ch2}, {ch3}\n")

    var ch4: int = f2.readChar()
    if ch4 != -1 =>
        print("  FAIL: should be -1 at EOF\n")
        errors++
    print($"  readChar at EOF: {ch4}\n")
    f2.close()

    // Test 3: Binary file position tracking
    print("\nTest 3 - Binary file position:\n")
    var bin_path: str = "/tmp/bin_state.bin"
    var bin_data: byte[] = {1, 2, 3, 4, 5}
    BinaryFile.writeAll(bin_path, bin_data)

    var bf: BinaryFile = BinaryFile.open(bin_path)
    var pos0: int = bf.position()
    print($"  Initial position: {pos0}\n")
    if pos0 != 0 =>
        print("  FAIL: initial position should be 0\n")
        errors++

    var b1: int = bf.readByte()
    var b2: int = bf.readByte()
    var pos2: int = bf.position()
    print($"  Position after 2 reads: {pos2}\n")
    if pos2 != 2 =>
        print("  FAIL: position should be 2\n")
        errors++

    // Test 4: Seek operation
    print("\nTest 4 - Seek operation:\n")
    bf.seek(0)
    var pos_after_seek: int = bf.position()
    print($"  Position after seek(0): {pos_after_seek}\n")
    if pos_after_seek != 0 =>
        print("  FAIL: position should be 0 after seek\n")
        errors++

    // Test 5: Rewind operation
    print("\nTest 5 - Rewind operation:\n")
    bf.readByte()
    bf.readByte()
    bf.rewind()
    var pos_after_rewind: int = bf.position()
    print($"  Position after rewind: {pos_after_rewind}\n")
    if pos_after_rewind != 0 =>
        print("  FAIL: position should be 0 after rewind\n")
        errors++
    bf.close()

    // Cleanup
    TextFile.delete(state_path)
    BinaryFile.delete(bin_path)

    // Results
    if errors == 0 =>
        print("\nAll file state tests PASSED!\n")
    if errors > 0 =>
        print($"\n{errors} tests FAILED!\n")

    return 0
