# ==============================================================================
# test_textfile.sn - Tests for SDK TextFile Type
# ==============================================================================
# Tests the SnTextFile struct and its methods.
# ==============================================================================

import "../../../sdk/io/textfile"

fn test_static_write_and_read(): void =>
    print("test_static_write_and_read: ")

    var testPath: str = "sdk_textfile_test1.txt"
    var content: str = "Hello, World!\nLine 2\nLine 3"

    # Write content
    SnTextFile.writeAll(testPath, content)

    # Read it back
    var readContent: str = SnTextFile.readAll(testPath)

    assert(readContent == content, "Content should match")

    # Clean up
    SnTextFile.delete(testPath)

    print("PASS\n")

fn test_exists(): void =>
    print("test_exists: ")

    var testPath: str = "sdk_textfile_test2.txt"

    # File should not exist yet
    assert(!SnTextFile.exists(testPath), "File should not exist initially")

    # Create it
    SnTextFile.writeAll(testPath, "test")

    # Now it should exist
    assert(SnTextFile.exists(testPath), "File should exist after creation")

    # Clean up
    SnTextFile.delete(testPath)

    # Should not exist anymore
    assert(!SnTextFile.exists(testPath), "File should not exist after deletion")

    print("PASS\n")

fn test_instance_read_write(): void =>
    print("test_instance_read_write: ")

    var testPath: str = "sdk_textfile_test3.txt"

    # Open file and write
    var f: SnTextFile = SnTextFile.open(testPath)
    f.writeLine("Line 1")
    f.writeLine("Line 2")
    f.writeLine("Line 3")
    f.close()

    # Open and read back
    var f2: SnTextFile = SnTextFile.open(testPath)
    var line1: str = f2.readLine()
    var line2: str = f2.readLine()
    var line3: str = f2.readLine()
    f2.close()

    assert(line1 == "Line 1", "First line should match")
    assert(line2 == "Line 2", "Second line should match")
    assert(line3 == "Line 3", "Third line should match")

    # Clean up
    SnTextFile.delete(testPath)

    print("PASS\n")

fn test_read_lines(): void =>
    print("test_read_lines: ")

    var testPath: str = "sdk_textfile_test4.txt"
    SnTextFile.writeAll(testPath, "Alpha\nBeta\nGamma")

    var f: SnTextFile = SnTextFile.open(testPath)
    var lines: str[] = f.readLines()
    f.close()

    assert(lines.length == 3, "Should have 3 lines")
    assert(lines[0] == "Alpha", "First line")
    assert(lines[1] == "Beta", "Second line")
    assert(lines[2] == "Gamma", "Third line")

    SnTextFile.delete(testPath)

    print("PASS\n")

fn test_read_word(): void =>
    print("test_read_word: ")

    var testPath: str = "sdk_textfile_test5.txt"
    SnTextFile.writeAll(testPath, "one two  three\nfour")

    var f: SnTextFile = SnTextFile.open(testPath)
    var w1: str = f.readWord()
    var w2: str = f.readWord()
    var w3: str = f.readWord()
    var w4: str = f.readWord()
    f.close()

    assert(w1 == "one", "First word")
    assert(w2 == "two", "Second word")
    assert(w3 == "three", "Third word")
    assert(w4 == "four", "Fourth word")

    SnTextFile.delete(testPath)

    print("PASS\n")

fn test_position_and_seek(): void =>
    print("test_position_and_seek: ")

    var testPath: str = "sdk_textfile_test6.txt"
    SnTextFile.writeAll(testPath, "ABCDEFGHIJ")

    var f: SnTextFile = SnTextFile.open(testPath)

    # Read first 3 chars
    var c1: int = f.readChar()
    var c2: int = f.readChar()
    var c3: int = f.readChar()

    assert(c1 == 65, "First char should be 'A'")
    assert(c2 == 66, "Second char should be 'B'")
    assert(c3 == 67, "Third char should be 'C'")

    # Position should be 3
    assert(f.position() == 3, "Position should be 3")

    # Seek back to start
    f.seek(0)
    assert(f.position() == 0, "Position should be 0 after seek")

    # Read first char again
    var c4: int = f.readChar()
    assert(c4 == 65, "First char after seek should be 'A'")

    f.close()
    SnTextFile.delete(testPath)

    print("PASS\n")

fn test_eof_and_has_chars(): void =>
    print("test_eof_and_has_chars: ")

    var testPath: str = "sdk_textfile_test7.txt"
    SnTextFile.writeAll(testPath, "AB")

    var f: SnTextFile = SnTextFile.open(testPath)

    assert(!f.isEof(), "Should not be at EOF initially")
    assert(f.hasChars(), "Should have chars initially")

    f.readChar()
    f.readChar()

    assert(f.isEof(), "Should be at EOF after reading all")
    assert(!f.hasChars(), "Should not have chars after reading all")

    f.close()
    SnTextFile.delete(testPath)

    print("PASS\n")

fn test_copy_and_move(): void =>
    print("test_copy_and_move: ")

    var srcPath: str = "sdk_textfile_test_src.txt"
    var dstPath: str = "sdk_textfile_test_dst.txt"
    var movePath: str = "sdk_textfile_test_moved.txt"

    SnTextFile.writeAll(srcPath, "Copy test content")

    # Test copy
    SnTextFile.copy(srcPath, dstPath)
    assert(SnTextFile.exists(srcPath), "Source should still exist after copy")
    assert(SnTextFile.exists(dstPath), "Destination should exist after copy")
    assert(SnTextFile.readAll(dstPath) == "Copy test content", "Copied content should match")

    # Test move
    SnTextFile.move(dstPath, movePath)
    assert(!SnTextFile.exists(dstPath), "Source should not exist after move")
    assert(SnTextFile.exists(movePath), "Destination should exist after move")
    assert(SnTextFile.readAll(movePath) == "Copy test content", "Moved content should match")

    # Clean up
    SnTextFile.delete(srcPath)
    SnTextFile.delete(movePath)

    print("PASS\n")

fn test_properties(): void =>
    print("test_properties: ")

    var testPath: str = "sdk_textfile_test8.txt"
    SnTextFile.writeAll(testPath, "1234567890")  # 10 bytes

    var f: SnTextFile = SnTextFile.open(testPath)

    assert(f.size() == 10, "Size should be 10 bytes")
    assert(f.name() == "sdk_textfile_test8.txt", "Name should be filename only")

    f.close()
    SnTextFile.delete(testPath)

    print("PASS\n")

fn main(): void =>
    print("=== SDK TextFile Tests ===\n\n")

    test_static_write_and_read()
    test_exists()
    test_instance_read_write()
    test_read_lines()
    test_read_word()
    test_position_and_seek()
    test_eof_and_has_chars()
    test_copy_and_move()
    test_properties()

    print("\nAll TextFile tests passed!\n")
