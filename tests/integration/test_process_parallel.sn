// Test multiple concurrent processes
// Uses the Sindarin compiler itself for cross-platform testing

fn main(): int =>
    // Get compiler path (cross-platform)
    var sn: str = Path.absolute("bin/sn")
    if Environment.get("OS", "").contains("Windows") =>
        sn = Path.absolute("bin/sn.exe")

    var p1: Process = &Process.run(sn, {"--version"})
    var p2: Process = &Process.run(sn, {"--version"})
    var p3: Process = &Process.run(sn, {"--version"})

    print("all spawned\n")

    p1!
    p2!
    p3!

    print("all done\n")

    print($"p1: {p1.stdout.trim()}\n")
    print($"p2: {p2.stdout.trim()}\n")
    print($"p3: {p3.stdout.trim()}\n")

    var total: int = p1.exitCode + p2.exitCode + p3.exitCode
    print($"total exit: {total}\n")

    return 0
