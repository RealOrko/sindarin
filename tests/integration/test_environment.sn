// Test Environment type - accessing and modifying environment variables
//
// Tests:
// 1. Reading environment variables with get()
// 2. Setting environment variables with set()
// 3. Checking existence with has()
// 4. Typed getters (getInt, getLong, getDouble, getBool) with valid values
// 5. Default value fallback behavior
// 6. List and names operations
// 7. Removing environment variables

fn main(): int =>
    print("=== Environment Type Tests ===\n\n")

    // ============================================
    // Test 1: Basic get and set operations
    // ============================================
    print("--- Test 1: Basic get/set ---\n")

    // Set a test variable
    Environment.set("SN_TEST_VAR", "hello_world")
    var value: str = Environment.get("SN_TEST_VAR")
    print($"get(SN_TEST_VAR): {value}\n")

    // Verify PATH exists (standard env var)
    var hasPath: bool = Environment.has("PATH")
    print($"has(PATH): {hasPath}\n")

    // Test has() for non-existent variable
    var hasNonExistent: bool = Environment.has("SN_NONEXISTENT_VAR_XYZ")
    print($"has(SN_NONEXISTENT_VAR_XYZ): {hasNonExistent}\n")

    // ============================================
    // Test 2: Get with default value
    // ============================================
    print("\n--- Test 2: Get with default ---\n")

    // Existing variable - should return actual value
    var existingWithDefault: str = Environment.get("SN_TEST_VAR", "default_value")
    print($"get(SN_TEST_VAR, default): {existingWithDefault}\n")

    // Non-existing variable - should return default
    var nonExistingWithDefault: str = Environment.get("SN_NONEXISTENT_XYZ", "my_default")
    print($"get(SN_NONEXISTENT_XYZ, default): {nonExistingWithDefault}\n")

    // ============================================
    // Test 3: Typed getters with valid values
    // ============================================
    print("\n--- Test 3: Typed getters (valid) ---\n")

    // Set up test values
    Environment.set("SN_TEST_INT", "42")
    Environment.set("SN_TEST_LONG", "9876543210")
    Environment.set("SN_TEST_DOUBLE", "3.14159")
    Environment.set("SN_TEST_BOOL_TRUE", "true")
    Environment.set("SN_TEST_BOOL_YES", "yes")
    Environment.set("SN_TEST_BOOL_ONE", "1")
    Environment.set("SN_TEST_BOOL_FALSE", "false")
    Environment.set("SN_TEST_BOOL_NO", "no")
    Environment.set("SN_TEST_BOOL_ZERO", "0")

    // Test getInt
    var intVal: int = Environment.getInt("SN_TEST_INT")
    print($"getInt(SN_TEST_INT): {intVal}\n")

    // Test getLong
    var longVal: long = Environment.getLong("SN_TEST_LONG")
    print($"getLong(SN_TEST_LONG): {longVal}\n")

    // Test getDouble
    var doubleVal: double = Environment.getDouble("SN_TEST_DOUBLE")
    print($"getDouble(SN_TEST_DOUBLE): {doubleVal:.5f}\n")

    // Test getBool - various true values
    var boolTrue: bool = Environment.getBool("SN_TEST_BOOL_TRUE")
    var boolYes: bool = Environment.getBool("SN_TEST_BOOL_YES")
    var boolOne: bool = Environment.getBool("SN_TEST_BOOL_ONE")
    print($"getBool(true): {boolTrue}\n")
    print($"getBool(yes): {boolYes}\n")
    print($"getBool(1): {boolOne}\n")

    // Test getBool - various false values
    var boolFalse: bool = Environment.getBool("SN_TEST_BOOL_FALSE")
    var boolNo: bool = Environment.getBool("SN_TEST_BOOL_NO")
    var boolZero: bool = Environment.getBool("SN_TEST_BOOL_ZERO")
    print($"getBool(false): {boolFalse}\n")
    print($"getBool(no): {boolNo}\n")
    print($"getBool(0): {boolZero}\n")

    // ============================================
    // Test 4: Typed getters with defaults
    // ============================================
    print("\n--- Test 4: Typed getters with defaults ---\n")

    // Existing values - should return actual value
    var intWithDefault: int = Environment.getInt("SN_TEST_INT", 999)
    print($"getInt(SN_TEST_INT, 999): {intWithDefault}\n")

    // Non-existing values - should return default
    var intNonExistent: int = Environment.getInt("SN_NONEXISTENT_INT", 100)
    print($"getInt(SN_NONEXISTENT_INT, 100): {intNonExistent}\n")

    var longNonExistent: long = Environment.getLong("SN_NONEXISTENT_LONG", 200l)
    print($"getLong(SN_NONEXISTENT_LONG, 200): {longNonExistent}\n")

    var doubleNonExistent: double = Environment.getDouble("SN_NONEXISTENT_DOUBLE", 1.5)
    print($"getDouble(SN_NONEXISTENT_DOUBLE, 1.5): {doubleNonExistent:.1f}\n")

    var boolNonExistent: bool = Environment.getBool("SN_NONEXISTENT_BOOL", true)
    print($"getBool(SN_NONEXISTENT_BOOL, true): {boolNonExistent}\n")

    // ============================================
    // Test 5: List and names operations
    // ============================================
    print("\n--- Test 5: List and names ---\n")

    // Get all environment variable names
    var allNames: str[] = Environment.names()
    var namesCount: int = len(allNames)
    // Verify we have at least some variables (PATH, HOME, etc.)
    var hasEnoughNames: bool = namesCount > 5
    print($"names() has many variables: {hasEnoughNames}\n")

    // Verify test variable is in names
    var foundInNames: bool = false
    for i in 0..namesCount =>
        if allNames[i] == "SN_TEST_VAR" =>
            foundInNames = true
    print($"SN_TEST_VAR in names(): {foundInNames}\n")

    // Test list() returns [name, value] pairs
    var allPairs: str[][] = Environment.list()
    var pairsCount: int = len(allPairs)
    // Verify list() and names() return same count
    var sameCount: bool = pairsCount == namesCount
    print($"list() and names() same count: {sameCount}\n")

    // Verify test variable in list with correct value
    var foundInList: bool = false
    for i in 0..pairsCount =>
        if allPairs[i][0] == "SN_TEST_VAR" =>
            if allPairs[i][1] == "hello_world" =>
                foundInList = true
    print($"SN_TEST_VAR=hello_world in list(): {foundInList}\n")

    // ============================================
    // Test 6: Remove operation
    // ============================================
    print("\n--- Test 6: Remove ---\n")

    // Set then remove a variable
    Environment.set("SN_TEMP_VAR", "temporary")
    var hasTempBefore: bool = Environment.has("SN_TEMP_VAR")
    print($"has(SN_TEMP_VAR) before remove: {hasTempBefore}\n")

    var removed: bool = Environment.remove("SN_TEMP_VAR")
    print($"remove(SN_TEMP_VAR): {removed}\n")

    var hasTempAfter: bool = Environment.has("SN_TEMP_VAR")
    print($"has(SN_TEMP_VAR) after remove: {hasTempAfter}\n")

    // Remove non-existent variable returns false
    var removedNonExistent: bool = Environment.remove("SN_NONEXISTENT_XYZ")
    print($"remove(SN_NONEXISTENT_XYZ): {removedNonExistent}\n")

    // ============================================
    // Test 7: Empty string value
    // ============================================
    print("\n--- Test 7: Empty string value ---\n")

    Environment.set("SN_EMPTY_VAR", "")
    var hasEmpty: bool = Environment.has("SN_EMPTY_VAR")
    var emptyVal: str = Environment.get("SN_EMPTY_VAR")
    print($"has(SN_EMPTY_VAR): {hasEmpty}\n")
    var isEmpty: bool = emptyVal == ""
    print($"get(SN_EMPTY_VAR) is empty: {isEmpty}\n")

    // Empty string with default - should return empty string, not default
    var emptyWithDefault: str = Environment.get("SN_EMPTY_VAR", "default")
    var emptyDefaultIsEmpty: bool = emptyWithDefault == ""
    print($"get(SN_EMPTY_VAR, default) is empty: {emptyDefaultIsEmpty}\n")

    // ============================================
    // Cleanup
    // ============================================
    Environment.remove("SN_TEST_VAR")
    Environment.remove("SN_TEST_INT")
    Environment.remove("SN_TEST_LONG")
    Environment.remove("SN_TEST_DOUBLE")
    Environment.remove("SN_TEST_BOOL_TRUE")
    Environment.remove("SN_TEST_BOOL_YES")
    Environment.remove("SN_TEST_BOOL_ONE")
    Environment.remove("SN_TEST_BOOL_FALSE")
    Environment.remove("SN_TEST_BOOL_NO")
    Environment.remove("SN_TEST_BOOL_ZERO")
    Environment.remove("SN_EMPTY_VAR")

    print("\nPASS\n")
    return 0
