// Integration test for UUID generation and manipulation
// Tests factory methods, instance methods, and string operations

fn main(): void =>
    var passed: int = 0
    var failed: int = 0

    print("=== UUID Integration Tests ===\n")

    // ============================================================
    // FACTORY METHODS - UUID Creation
    // ============================================================
    print("--- Factory Methods ---\n")

    // Test UUID.new() - alias for create(), generates UUIDv7
    var id1: UUID = UUID.new()
    print("  PASS: UUID.new() succeeded\n")
    passed = passed + 1

    // Test UUID.create() - generates UUIDv7 (time-ordered)
    var id2: UUID = UUID.create()
    print("  PASS: UUID.create() succeeded\n")
    passed = passed + 1

    // Test UUID.v7() - explicit v7 generation
    var v7id: UUID = UUID.v7()
    print("  PASS: UUID.v7() succeeded\n")
    passed = passed + 1

    // Test UUID.v4() - pure random UUID
    var v4id: UUID = UUID.v4()
    print("  PASS: UUID.v4() succeeded\n")
    passed = passed + 1

    // ============================================================
    // VERSION VERIFICATION
    // ============================================================
    print("\n--- Version Verification ---\n")

    // Check that v7 UUID reports version 7
    var ver7: int = v7id.version()
    if ver7 == 7 =>
        print("  PASS: v7 UUID reports version 7\n")
        passed = passed + 1
    else =>
        print($"  FAIL: v7 UUID reports version {ver7}, expected 7\n")
        failed = failed + 1

    // Check that v4 UUID reports version 4
    var ver4: int = v4id.version()
    if ver4 == 4 =>
        print("  PASS: v4 UUID reports version 4\n")
        passed = passed + 1
    else =>
        print($"  FAIL: v4 UUID reports version {ver4}, expected 4\n")
        failed = failed + 1

    // ============================================================
    // TOSTRING METHOD
    // ============================================================
    print("\n--- toString Method ---\n")

    // Test toString() produces valid format
    var str1: str = id1.toString()

    // Verify length is 36 characters (8-4-4-4-12 with dashes)
    if str1.length == 36 =>
        print("  PASS: toString() returns 36-char string\n")
        passed = passed + 1
    else =>
        print($"  FAIL: toString() returns {str1.length} chars, expected 36\n")
        failed = failed + 1

    // Test multiple UUIDs produce different strings
    var str2: str = id2.toString()
    if str1 != str2 =>
        print("  PASS: Different UUIDs have different string representations\n")
        passed = passed + 1
    else =>
        print("  FAIL: Different UUIDs have same string representation\n")
        failed = failed + 1

    // ============================================================
    // EQUALS METHOD
    // ============================================================
    print("\n--- equals Method ---\n")

    // Different UUIDs should not be equal
    if id1.equals(id2) =>
        print("  FAIL: Different UUIDs reported as equal\n")
        failed = failed + 1
    else =>
        print("  PASS: Different UUIDs are not equal\n")
        passed = passed + 1

    // Same UUID should equal itself
    if id1.equals(id1) =>
        print("  PASS: Same UUID equals itself\n")
        passed = passed + 1
    else =>
        print("  FAIL: Same UUID does not equal itself\n")
        failed = failed + 1

    // ============================================================
    // STRING PARSING
    // ============================================================
    print("\n--- String Parsing ---\n")

    // Test fromString() parsing
    var parsed: UUID = UUID.fromString("01234567-89ab-7def-8123-456789abcdef")
    var parsedStr: str = parsed.toString()
    if parsedStr == "01234567-89ab-7def-8123-456789abcdef" =>
        print("  PASS: UUID.fromString() round-trips correctly\n")
        passed = passed + 1
    else =>
        print($"  FAIL: fromString() produced {parsedStr}\n")
        failed = failed + 1

    // ============================================================
    // V5 DETERMINISTIC UUIDS
    // ============================================================
    print("\n--- V5 Deterministic UUIDs ---\n")

    // Get namespace UUID
    var nsUrl: UUID = UUID.namespaceUrl()
    var nsUrlStr: str = nsUrl.toString()
    if nsUrlStr == "6ba7b811-9dad-11d1-80b4-00c04fd430c8" =>
        print("  PASS: Namespace URL is correct\n")
        passed = passed + 1
    else =>
        print($"  FAIL: Namespace URL is {nsUrlStr}\n")
        failed = failed + 1

    // Generate v5 UUID from namespace and name
    var v5id1: UUID = UUID.v5(nsUrl, "https://example.com/test")
    var v5id2: UUID = UUID.v5(nsUrl, "https://example.com/test")

    // Same input should produce same UUID
    if v5id1.equals(v5id2) =>
        print("  PASS: v5 with same input produces same UUID\n")
        passed = passed + 1
    else =>
        print("  FAIL: v5 with same input produces different UUIDs\n")
        failed = failed + 1

    // Different input should produce different UUID
    var v5id3: UUID = UUID.v5(nsUrl, "https://example.com/other")
    if v5id1.equals(v5id3) =>
        print("  FAIL: v5 with different input produces same UUID\n")
        failed = failed + 1
    else =>
        print("  PASS: v5 with different input produces different UUID\n")
        passed = passed + 1

    // v5 should report version 5
    var ver5: int = v5id1.version()
    if ver5 == 5 =>
        print("  PASS: v5 UUID reports version 5\n")
        passed = passed + 1
    else =>
        print($"  FAIL: v5 UUID reports version {ver5}, expected 5\n")
        failed = failed + 1

    // ============================================================
    // VARIANT CHECK
    // ============================================================
    print("\n--- Variant Check ---\n")

    // All RFC 9562 UUIDs should have variant 1 (RFC 4122/9562)
    var variant: int = id1.variant()
    if variant == 1 =>
        print("  PASS: UUID variant is 1 (RFC 9562)\n")
        passed = passed + 1
    else =>
        print($"  FAIL: UUID variant is {variant}, expected 1\n")
        failed = failed + 1

    // ============================================================
    // TIMESTAMP EXTRACTION (V7 only)
    // ============================================================
    print("\n--- Timestamp Extraction (v7) ---\n")

    // v7 UUID should have extractable timestamp
    var ts: long = v7id.timestamp()
    // Timestamp should be positive and reasonable (after year 2020)
    if ts > 1577836800000l =>
        print("  PASS: v7 timestamp is valid\n")
        passed = passed + 1
    else =>
        print($"  FAIL: v7 timestamp {ts} seems invalid\n")
        failed = failed + 1

    // ============================================================
    // HEX AND BASE64 FORMATS
    // ============================================================
    print("\n--- Alternative Formats ---\n")

    // Test toHex() - 32 character hex string
    var hexStr: str = id1.toHex()
    if hexStr.length == 32 =>
        print("  PASS: toHex() returns 32-char string\n")
        passed = passed + 1
    else =>
        print($"  FAIL: toHex() returns {hexStr.length} chars\n")
        failed = failed + 1

    // Test toBase64() - 22 character base64 string
    var b64Str: str = id1.toBase64()
    if b64Str.length == 22 =>
        print("  PASS: toBase64() returns 22-char string\n")
        passed = passed + 1
    else =>
        print($"  FAIL: toBase64() returns {b64Str.length} chars\n")
        failed = failed + 1

    // ============================================================
    // NIL AND MAX SPECIAL UUIDS
    // ============================================================
    print("\n--- Nil and Max UUIDs ---\n")

    // Test UUID.zero() - all zeros (nil UUID)
    var zeroUuid: UUID = UUID.zero()
    var zeroStr: str = zeroUuid.toString()
    if zeroStr == "00000000-0000-0000-0000-000000000000" =>
        print("  PASS: UUID.zero() is all zeros\n")
        passed = passed + 1
    else =>
        print($"  FAIL: UUID.zero() is {zeroStr}\n")
        failed = failed + 1

    // Test nil UUID isNil() method
    if zeroUuid.isNil() =>
        print("  PASS: zero UUID reports isNil() == true\n")
        passed = passed + 1
    else =>
        print("  FAIL: zero UUID reports isNil() == false\n")
        failed = failed + 1

    // Test regular UUID is NOT nil
    if id1.isNil() =>
        print("  FAIL: regular UUID reports isNil() == true\n")
        failed = failed + 1
    else =>
        print("  PASS: regular UUID reports isNil() == false\n")
        passed = passed + 1

    // Test UUID.max() - all ones
    var maxUuid: UUID = UUID.max()
    var maxStr: str = maxUuid.toString()
    if maxStr == "ffffffff-ffff-ffff-ffff-ffffffffffff" =>
        print("  PASS: UUID.max() is all ones\n")
        passed = passed + 1
    else =>
        print($"  FAIL: UUID.max() is {maxStr}\n")
        failed = failed + 1

    // ============================================================
    // COMPARISON OPERATORS
    // ============================================================
    print("\n--- Comparison Operators ---\n")

    // Test == operator (equality)
    var eqUuid1: UUID = UUID.fromString("01234567-89ab-7def-8123-456789abcdef")
    var eqUuid2: UUID = UUID.fromString("01234567-89ab-7def-8123-456789abcdef")
    if eqUuid1 == eqUuid2 =>
        print("  PASS: == operator works for equal UUIDs\n")
        passed = passed + 1
    else =>
        print("  FAIL: == operator failed for equal UUIDs\n")
        failed = failed + 1

    // Test != operator (inequality)
    if id1 != id2 =>
        print("  PASS: != operator works for different UUIDs\n")
        passed = passed + 1
    else =>
        print("  FAIL: != operator failed for different UUIDs\n")
        failed = failed + 1

    // Test < operator (less than)
    // zero < max should always be true
    if zeroUuid < maxUuid =>
        print("  PASS: zero < max is true\n")
        passed = passed + 1
    else =>
        print("  FAIL: zero < max should be true\n")
        failed = failed + 1

    // Test > operator (greater than)
    // max > zero should always be true
    if maxUuid > zeroUuid =>
        print("  PASS: max > zero is true\n")
        passed = passed + 1
    else =>
        print("  FAIL: max > zero should be true\n")
        failed = failed + 1

    // Test <= operator (less than or equal)
    // zero <= zero should be true
    var zeroUuid2: UUID = UUID.zero()
    if zeroUuid <= zeroUuid2 =>
        print("  PASS: zero <= zero is true\n")
        passed = passed + 1
    else =>
        print("  FAIL: zero <= zero should be true\n")
        failed = failed + 1

    // Test >= operator (greater than or equal)
    // max >= max should be true
    var maxUuid2: UUID = UUID.max()
    if maxUuid >= maxUuid2 =>
        print("  PASS: max >= max is true\n")
        passed = passed + 1
    else =>
        print("  FAIL: max >= max should be true\n")
        failed = failed + 1

    // Test ordering with known values: small UUID vs large UUID
    // Use fromString to create UUIDs with known ordering
    var smallUuid: UUID = UUID.fromString("00000001-0000-7000-8000-000000000000")
    var largeUuid: UUID = UUID.fromString("00000002-0000-7000-8000-000000000000")
    if smallUuid < largeUuid =>
        print("  PASS: ordering works with known values (small < large)\n")
        passed = passed + 1
    else =>
        print("  FAIL: ordering should work with known values\n")
        failed = failed + 1

    // ============================================================
    // PRACTICAL USE CASE: Unique Record IDs
    // ============================================================
    print("\n--- Practical Use Case ---\n")

    // Generate multiple IDs as you would for database records
    var record1: UUID = UUID.create()
    var record2: UUID = UUID.create()
    var record3: UUID = UUID.create()

    // All should be unique
    var allUnique: bool = true
    if record1.equals(record2) =>
        allUnique = false

    if record2.equals(record3) =>
        allUnique = false

    if record1.equals(record3) =>
        allUnique = false

    if allUnique =>
        print("  PASS: Multiple generated UUIDs are all unique\n")
        passed = passed + 1
    else =>
        print("  FAIL: Generated UUIDs have collision\n")
        failed = failed + 1

    // ============================================================
    // SUMMARY
    // ============================================================
    print("\n=== Test Summary ===\n")
    print($"Passed: {passed}\n")
    print($"Failed: {failed}\n")

    if failed == 0 =>
        print("\nAll UUID integration tests PASSED!\n")
    else =>
        print("\nSome tests FAILED!\n")
