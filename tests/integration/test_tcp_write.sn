// Test: TCP write operations
// Uses pure Sindarin threading - no external dependencies

fn serverTask(server: TcpListener): str =>
    var client: TcpStream = server.accept()
    // Read what client sends
    var data: byte[] = client.read(1024)
    var received: str = data.toString()
    // Echo it back so client can verify
    client.write(data)
    client.close()
    return received

fn main(): void =>
    // Create listener first to get the port
    var server: TcpListener = TcpListener.bind("127.0.0.1:0")
    var port: int = server.port

    // Spawn server thread
    var serverThread: str = &serverTask(server)

    // Small delay to ensure server thread is ready
    Time.sleep(100)

    // Connect to server
    var client: TcpStream = TcpStream.connect($"127.0.0.1:{port}")
    print("Connected\n")

    // Write test data
    var testData: byte[] = "TEST DATA".toBytes()
    client.write(testData)
    print("Wrote bytes\n")

    // Read echo back to verify server received it
    var echo: byte[] = client.read(1024)
    var echoStr: str = echo.toString()

    client.close()
    print("Closed\n")

    // Wait for server thread and get what it received
    serverThread!
    var received: str = serverThread
    print($"Server received: {received}\n")

    if received == "TEST DATA" =>
        print("Write test passed\n")
    else =>
        print("Write test failed\n")

    server.close()
    print("Test complete\n")
