// Test: TCP write operations
// Uses Python as a server to receive and verify data
// Cross-platform: works on Windows and Linux

fn main(): void =>
    // Use a simple fixed path for the ready file to avoid environment variable issues
    var readyFile: str = "tcp_write_ready.tmp"

    // Clean up temp file if it exists (cross-platform)
    if Path.exists(readyFile) =>
        TextFile.delete(readyFile)

    // Start a Python server that receives data and prints what it got
    var server: Process = &Process.run("python", {"-c", "import socket;s=socket.socket();s.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1);s.bind(('127.0.0.1',0));s.listen(1);p=s.getsockname()[1];open('tcp_write_ready.tmp','w').write(str(p));c,a=s.accept();d=c.recv(1024);print(d.decode(),end='');c.close();s.close()"})

    // Wait for server to be ready using cross-platform methods
    // Use longer timeout for slow CI environments (200 attempts Ã— 100ms = 20 seconds)
    var attempts: int = 0
    while attempts < 200 =>
        if Path.exists(readyFile) =>
            attempts = 300
        else =>
            Time.sleep(100)  // 100ms
            attempts = attempts + 1

    if attempts < 300 =>
        print("Timeout waiting for server\n")
        return

    // Read the port number from the temp file (cross-platform)
    var port: str = TextFile.readAll(readyFile).trim()

    // Connect to the Python server
    var client: TcpStream = TcpStream.connect($"127.0.0.1:{port}")
    print("Connected\n")

    // Test write with byte array
    var testData: byte[] = "TEST DATA".toBytes()
    client.write(testData)
    print("Wrote bytes\n")

    client.close()
    print("Closed\n")

    // Wait for server and check what it received
    server!
    var received: str = server.stdout
    print($"Server received: {received}\n")

    if received == "TEST DATA" =>
        print("Write test passed\n")
    else =>
        print("Write test failed\n")

    // Clean up (cross-platform)
    if Path.exists(readyFile) =>
        TextFile.delete(readyFile)
    print("Test complete\n")
