// Test: TCP connect and basic operations
// Uses pure Sindarin threading - no external dependencies

import "../../sdk/time"

fn serverTask(server: TcpListener): int =>
    var client: TcpStream = server.accept()
    client.write("HELLO FROM SERVER".toBytes())
    client.close()
    return 0

fn main(): void =>
    // Create listener first to get the port
    var server: TcpListener = TcpListener.bind("127.0.0.1:0")
    var port: int = server.port

    // Spawn server thread to handle connection
    var serverThread: int = &serverTask(server)

    // Small delay to ensure server thread is ready to accept
    SnTime.sleep(100)

    // Connect to the server
    print("[DEBUG] Connecting to server...\n")
    var client: TcpStream = TcpStream.connect($"127.0.0.1:{port}")
    print("Connected to server\n")

    // Check remote address contains expected IP
    var remote: str = client.remoteAddress
    if remote.contains("127.0.0.1") =>
        print("Remote address correct\n")
    else =>
        print($"Remote address unexpected: {remote}\n")

    // Read data from server
    print("[DEBUG] Reading data from socket...\n")
    var data: byte[] = client.read(1024)
    var msg: str = data.toString()
    print($"Received: {msg}\n")

    if msg == "HELLO FROM SERVER" =>
        print("Message matches\n")
    else =>
        print("Message mismatch\n")

    client.close()
    print("Connection closed\n")

    // Wait for server thread to complete
    print("[DEBUG] Syncing server thread...\n")
    serverThread!
    print("[DEBUG] Server thread completed\n")

    server.close()
    print("Test complete\n")
