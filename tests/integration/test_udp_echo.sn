// Test: UDP sendTo and receiveFrom operations
// Uses pure Sindarin threading - no external dependencies

fn serverTask(server: UdpSocket): str =>
    // Receive datagram and echo it back with prefix
    var data: byte[] = server.receiveFrom(1024)
    var sender: str = server.lastSender
    var echoData: byte[] = $"ECHO:{data.toString()}".toBytes()
    server.sendTo(echoData, sender)
    // Return sender info for verification
    return sender

fn main(): void =>
    // Create server socket first to get the port
    var server: UdpSocket = UdpSocket.bind("127.0.0.1:0")
    var serverPort: int = server.port

    // Spawn server thread to handle one datagram
    var serverThread: str = &serverTask(server)

    // Small delay to ensure server thread is ready
    Time.sleep(100)

    // Create client socket
    var client: UdpSocket = UdpSocket.bind("127.0.0.1:0")
    var clientPort: int = client.port
    print("Client bound\n")

    // Test 1: Send datagram to server
    var message: byte[] = "Hello UDP".toBytes()
    client.sendTo(message, $"127.0.0.1:{serverPort}")
    print("Test 1 PASS: Datagram sent\n")

    // Test 2: Receive echo response
    var response: byte[] = client.receiveFrom(1024)
    var respStr: str = response.toString()

    if respStr.startsWith("ECHO:") =>
        print("Test 2 PASS: Received echo prefix\n")
    else =>
        print($"Test 2 FAIL: Response was {respStr}\n")

    // Test 3: Check echoed content
    if respStr == "ECHO:Hello UDP" =>
        print("Test 3 PASS: Echo content correct\n")
    else =>
        print($"Test 3 FAIL: Expected ECHO:Hello UDP got {respStr}\n")

    client.close()

    // Wait for server thread and get sender info it captured
    serverThread!
    var senderInfo: str = serverThread

    // Test 4: Server saw sender address
    if senderInfo.contains("127.0.0.1") =>
        print("Test 4 PASS: Server saw sender IP\n")
    else =>
        print($"Test 4 FAIL: Server saw {senderInfo}\n")

    // Test 5: Server saw client port
    if senderInfo.contains($"{clientPort}") =>
        print("Test 5 PASS: Server saw sender port\n")
    else =>
        print("Test 5 FAIL: Server did not see correct port\n")

    server.close()
    print("All UDP echo tests complete\n")
