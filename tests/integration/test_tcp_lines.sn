// Test: TCP line-based protocol (readLine, writeLine)
// Uses pure Sindarin threading - no external dependencies

fn serverTask(server: TcpListener): int =>
    var client: TcpStream = server.accept()
    // Send greeting
    client.writeLine("GREETING")
    // Receive line from client
    var received: str = client.readLine()
    // Echo it back with prefix
    client.writeLine($"ECHO:{received}")
    client.close()
    return 0

fn main(): void =>
    // Create listener first to get the port
    var server: TcpListener = TcpListener.bind("127.0.0.1:0")
    var port: int = server.port

    // Spawn server thread
    var serverThread: int = &serverTask(server)

    // Small delay to ensure server thread is ready
    Time.sleep(100)

    // Connect to server
    var client: TcpStream = TcpStream.connect($"127.0.0.1:{port}")
    print("Connected\n")

    // Read greeting
    var greeting: str = client.readLine()
    print($"Received line: {greeting}\n")

    if greeting == "GREETING" =>
        print("Greeting correct\n")
    else =>
        print("Greeting incorrect\n")

    // Send line
    client.writeLine("HELLO WORLD")
    print("Sent line\n")

    // Read echo
    var echo: str = client.readLine()
    print($"Echo received: {echo}\n")

    if echo == "ECHO:HELLO WORLD" =>
        print("Echo correct\n")
    else =>
        print("Echo incorrect\n")

    client.close()
    print("Closed\n")

    // Wait for server thread
    serverThread!

    server.close()
    print("Test complete\n")
