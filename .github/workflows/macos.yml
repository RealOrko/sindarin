# GitHub Actions CI workflow for macOS
# Builds and tests the Sn compiler on macOS using Clang

name: macOS Build

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'docs/**'
  pull_request:
    branches: [ main, master, develop ]
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja coreutils zlib

    - name: Verify tools
      run: |
        echo "=== Checking clang ==="
        clang --version
        echo ""
        echo "=== Checking cmake ==="
        cmake --version
        echo ""
        echo "=== Checking ninja ==="
        ninja --version

    - name: Configure CMake
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Release

    - name: Build compiler
      run: |
        cmake --build build

    - name: Verify build outputs
      run: |
        echo "Checking for compiler executable..."
        if [ ! -f "bin/sn" ]; then
          echo "ERROR: bin/sn not found"
          exit 1
        fi
        echo "Found: bin/sn"

        echo "Checking for test executable..."
        if [ ! -f "bin/tests" ]; then
          echo "ERROR: bin/tests not found"
          exit 1
        fi
        echo "Found: bin/tests"

        echo "Checking for runtime objects..."
        if [ ! -f "bin/lib/gcc/arena.o" ]; then
          echo "ERROR: bin/lib/gcc/arena.o not found"
          exit 1
        fi
        echo "Found: bin/lib/gcc/*.o"

        echo ""
        echo "Build outputs verified successfully!"

    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        bin/tests
        echo "Unit tests passed!"

    - name: Run integration tests
      env:
        SN_CC: clang
        # Exclude tests that have ASAN compatibility issues on macOS
        SN_EXCLUDE_TESTS: "test_thread_panic_propagate"
      run: |
        echo "Running integration tests..."
        ./scripts/run_tests.sh integration
        echo "Running integration error tests..."
        ./scripts/run_tests.sh integration-errors
        echo "All integration tests passed!"

    - name: Run exploratory tests
      env:
        SN_CC: clang
      run: |
        echo "Running exploratory tests..."
        ./scripts/run_tests.sh explore
        echo "Running exploratory error tests..."
        ./scripts/run_tests.sh explore-errors
        echo "All exploratory tests passed!"

    - name: Run SDK tests
      env:
        SN_CC: clang
      run: |
        echo "Running SDK tests..."
        # Homebrew zlib is keg-only, need explicit paths
        export SN_CFLAGS="-I$(brew --prefix zlib)/include"
        export SN_LDFLAGS="-L$(brew --prefix zlib)/lib"
        echo "SN_CFLAGS=$SN_CFLAGS"
        echo "SN_LDFLAGS=$SN_LDFLAGS"
        ./scripts/run_tests.sh sdk
        echo "All SDK tests passed!"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: sn-macos-x64
        path: |
          bin/sn
          bin/tests
          bin/lib/gcc/*.o
          bin/include/**/*
          bin/*.cfg
        retention-days: 7

  # Debug build job (triggered manually)
  build-debug:
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake ninja coreutils zlib

    - name: Configure CMake (Debug)
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Debug -DSN_DEBUG=ON -DSN_ASAN=ON

    - name: Build compiler (Debug)
      run: |
        cmake --build build

    - name: Run unit tests (Debug)
      env:
        SN_CC: clang
      run: |
        bin/tests
