# GitHub Actions CI workflow for Windows
# Builds and tests the Sn compiler on Windows using LLVM-MinGW

name: Windows Build

on:
  push:
    branches: [ main, master ]  # Only run on merges to main/master
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Remove system LLVM (conflicts with LLVM-MinGW)
      shell: pwsh
      run: |
        # GitHub runners have LLVM pre-installed at C:\Program Files\LLVM
        # This interferes with LLVM-MinGW's resource directory detection
        if (Test-Path "C:\Program Files\LLVM") {
          Write-Host "Removing system LLVM to avoid conflicts..."
          Remove-Item -Path "C:\Program Files\LLVM" -Recurse -Force
        }

    - name: Install LLVM-MinGW
      shell: pwsh
      run: |
        # Download and extract LLVM-MinGW (self-contained toolchain)
        $version = "20241217"
        $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/$version/llvm-mingw-$version-ucrt-x86_64.zip"
        $zipPath = "$env:TEMP\llvm-mingw.zip"
        $extractPath = "C:\llvm-mingw"

        Write-Host "Downloading LLVM-MinGW $version..."
        Invoke-WebRequest -Uri $url -OutFile $zipPath

        Write-Host "Extracting to $extractPath..."
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

        # Find the extracted directory and add bin to PATH
        $llvmDir = Get-ChildItem -Path $extractPath -Directory | Select-Object -First 1
        $binPath = Join-Path $llvmDir.FullName "bin"

        Write-Host "LLVM-MinGW installed at: $($llvmDir.FullName)"
        echo "$binPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

        # Save the install path for later steps
        echo "LLVM_MINGW_PATH=$($llvmDir.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Install Ninja
      shell: pwsh
      run: |
        choco install ninja -y

    - name: Verify tools
      shell: pwsh
      run: |
        Write-Host "=== Checking clang ===" -ForegroundColor Cyan
        Write-Host "Clang path: $(Get-Command clang | Select-Object -ExpandProperty Source)"
        clang --version

        Write-Host ""
        Write-Host "=== Checking cmake ===" -ForegroundColor Cyan
        cmake --version

        Write-Host ""
        Write-Host "=== Checking ninja ===" -ForegroundColor Cyan
        ninja --version

        Write-Host ""
        Write-Host "=== LLVM-MinGW Install Path ===" -ForegroundColor Cyan
        Write-Host "$env:LLVM_MINGW_PATH"

    - name: Configure CMake
      shell: cmd
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Release
        if errorlevel 1 exit /b 1

    - name: Build compiler
      shell: cmd
      run: |
        cmake --build build
        if errorlevel 1 exit /b 1

    - name: Verify build outputs
      shell: cmd
      run: |
        echo Checking for compiler executable...
        if not exist "bin\sn.exe" (
          echo ERROR: bin\sn.exe not found
          exit /b 1
        )
        echo Found: bin\sn.exe

        echo Checking for test executable...
        if not exist "bin\tests.exe" (
          echo ERROR: bin\tests.exe not found
          exit /b 1
        )
        echo Found: bin\tests.exe

        echo Checking for runtime objects...
        if not exist "bin\lib\clang\arena.o" (
          echo ERROR: bin\lib\clang\arena.o not found
          exit /b 1
        )
        echo Found: bin\lib\clang\*.o

        echo.
        echo Build outputs verified successfully!

    - name: Run unit tests
      shell: cmd
      run: |
        echo Running unit tests...
        bin\tests.exe
        if errorlevel 1 (
          echo Unit tests failed!
          exit /b 1
        )
        echo Unit tests passed!

    - name: Diagnostic - test_tcp_connect
      shell: pwsh
      env:
        SN_CC: clang
        SN_CFLAGS: --target=x86_64-w64-mingw32 -fuse-ld=lld -rtlib=compiler-rt -unwindlib=none
      run: |
        Write-Host "=== DIAGNOSTIC: test_tcp_connect ===" -ForegroundColor Cyan
        Write-Host ""

        # Check Python availability
        Write-Host "--- Python Check ---" -ForegroundColor Yellow
        try {
          $pythonVersion = & python --version 2>&1
          Write-Host "Python: $pythonVersion"
          $pythonPath = (Get-Command python).Source
          Write-Host "Python path: $pythonPath"
        } catch {
          Write-Host "ERROR: Python not found!" -ForegroundColor Red
        }

        # Check environment
        Write-Host ""
        Write-Host "--- Environment ---" -ForegroundColor Yellow
        Write-Host "TEMP: $env:TEMP"
        Write-Host "SN_CC: $env:SN_CC"
        Write-Host "SN_CFLAGS: $env:SN_CFLAGS"
        Write-Host "Working dir: $(Get-Location)"

        # Compile the test
        Write-Host ""
        Write-Host "--- Compiling test_tcp_connect.sn ---" -ForegroundColor Yellow
        $compileResult = & bin\sn.exe tests\integration\test_tcp_connect.sn -o build\diag_tcp_connect.exe -l 3 -v 2>&1
        Write-Host $compileResult

        if (-not (Test-Path "build\diag_tcp_connect.exe")) {
          Write-Host "ERROR: Compilation failed - no executable produced" -ForegroundColor Red
          exit 0  # Don't fail the build, just report
        }

        # Run the test with timeout
        Write-Host ""
        Write-Host "--- Running test_tcp_connect ---" -ForegroundColor Yellow
        Write-Host "Starting test at $(Get-Date -Format 'HH:mm:ss.fff')"

        $pinfo = New-Object System.Diagnostics.ProcessStartInfo
        $pinfo.FileName = (Resolve-Path "build\diag_tcp_connect.exe").Path
        $pinfo.WorkingDirectory = (Get-Location).Path
        $pinfo.RedirectStandardOutput = $true
        $pinfo.RedirectStandardError = $true
        $pinfo.UseShellExecute = $false
        $pinfo.CreateNoWindow = $true

        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $pinfo

        try {
          $process.Start() | Out-Null
          $stdout = $process.StandardOutput.ReadToEndAsync()
          $stderr = $process.StandardError.ReadToEndAsync()

          $completed = $process.WaitForExit(30000)  # 30 second timeout

          if (-not $completed) {
            Write-Host "ERROR: Test timed out after 30 seconds!" -ForegroundColor Red
            $process.Kill()
          }

          Write-Host ""
          Write-Host "--- STDOUT ---" -ForegroundColor Yellow
          Write-Host $stdout.Result

          Write-Host ""
          Write-Host "--- STDERR ---" -ForegroundColor Yellow
          Write-Host $stderr.Result

          Write-Host ""
          Write-Host "--- Result ---" -ForegroundColor Yellow
          Write-Host "Exit code: $($process.ExitCode)"
          Write-Host "Completed at $(Get-Date -Format 'HH:mm:ss.fff')"

        } catch {
          Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
        }

        # Check for ready file
        Write-Host ""
        Write-Host "--- Checking temp files ---" -ForegroundColor Yellow
        $readyFile = Join-Path $env:TEMP "tcp_connect_ready"
        if (Test-Path $readyFile) {
          Write-Host "Ready file exists: $readyFile"
          Write-Host "Contents: $(Get-Content $readyFile)"
        } else {
          Write-Host "Ready file does NOT exist: $readyFile"
        }

        Write-Host ""
        Write-Host "=== END DIAGNOSTIC ===" -ForegroundColor Cyan

    - name: Debug - Check runtime objects
      shell: cmd
      run: |
        echo === Checking bin directory structure ===
        dir /s bin\lib
        echo.
        echo === Checking for arena.o ===
        if exist "bin\lib\clang\arena.o" (
          echo FOUND: bin\lib\clang\arena.o
        ) else (
          echo MISSING: bin\lib\clang\arena.o
        )

    - name: Debug - Test single compile
      shell: cmd
      env:
        SN_CC: clang
        SN_CFLAGS: --target=x86_64-w64-mingw32 -fuse-ld=lld -rtlib=compiler-rt -unwindlib=none
      run: |
        echo === Testing single compile with verbose output ===
        bin\sn.exe tests\integration\hello_world.sn -o build\hello_test.exe -l 3 -v
        if errorlevel 1 (
          echo Compile failed!
          exit /b 1
        )
        echo === Running compiled test ===
        build\hello_test.exe

    - name: Run integration tests
      shell: pwsh
      env:
        SN_CC: clang
        SN_CFLAGS: --target=x86_64-w64-mingw32 -fuse-ld=lld -rtlib=compiler-rt -unwindlib=none
      run: |
        Write-Host "Running integration tests..."
        Write-Host "SN_CC = $env:SN_CC"
        Write-Host "SN_CFLAGS = $env:SN_CFLAGS"

        # Use the test runner script
        & .\scripts\run_integration_test.ps1 -TestType integration -All -Compiler bin\sn.exe
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Integration tests failed!" -ForegroundColor Red
          exit 1
        }

        Write-Host "Running integration error tests..."
        & .\scripts\run_integration_test.ps1 -TestType integration-errors -All -Compiler bin\sn.exe
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Integration error tests failed!" -ForegroundColor Red
          exit 1
        }

        Write-Host "All integration tests passed!" -ForegroundColor Green

    - name: Run exploratory tests
      shell: pwsh
      env:
        SN_CC: clang
        SN_CFLAGS: --target=x86_64-w64-mingw32 -fuse-ld=lld -rtlib=compiler-rt -unwindlib=none
      run: |
        Write-Host "Running exploratory tests..."

        & .\scripts\run_integration_test.ps1 -TestType explore -All -Compiler bin\sn.exe
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Exploratory tests failed!" -ForegroundColor Red
          exit 1
        }

        Write-Host "Running exploratory error tests..."
        & .\scripts\run_integration_test.ps1 -TestType explore-errors -All -Compiler bin\sn.exe
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Exploratory error tests failed!" -ForegroundColor Red
          exit 1
        }

        Write-Host "All exploratory tests passed!" -ForegroundColor Green

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: sn-windows-x64
        path: |
          bin/sn.exe
          bin/tests.exe
          bin/lib/clang/*.o
          bin/include/**/*
          bin/*.cfg
        retention-days: 7

  # Debug build job (triggered manually)
  build-debug:
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Remove system LLVM (conflicts with LLVM-MinGW)
      shell: pwsh
      run: |
        if (Test-Path "C:\Program Files\LLVM") {
          Write-Host "Removing system LLVM to avoid conflicts..."
          Remove-Item -Path "C:\Program Files\LLVM" -Recurse -Force
        }

    - name: Install LLVM-MinGW
      shell: pwsh
      run: |
        # Download and extract LLVM-MinGW (self-contained toolchain)
        $version = "20241217"
        $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/$version/llvm-mingw-$version-ucrt-x86_64.zip"
        $zipPath = "$env:TEMP\llvm-mingw.zip"
        $extractPath = "C:\llvm-mingw"

        Write-Host "Downloading LLVM-MinGW $version..."
        Invoke-WebRequest -Uri $url -OutFile $zipPath

        Write-Host "Extracting to $extractPath..."
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force

        $llvmDir = Get-ChildItem -Path $extractPath -Directory | Select-Object -First 1
        $binPath = Join-Path $llvmDir.FullName "bin"

        Write-Host "LLVM-MinGW installed at: $($llvmDir.FullName)"
        echo "$binPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install Ninja
      shell: pwsh
      run: choco install ninja -y

    - name: Configure CMake (Debug)
      shell: cmd
      run: |
        cmake -S . -B build -G Ninja -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Debug -DSN_DEBUG=ON -DSN_ASAN=ON

    - name: Build compiler (Debug)
      shell: cmd
      run: |
        cmake --build build

    - name: Run unit tests (Debug)
      shell: cmd
      env:
        SN_CC: clang
        SN_CFLAGS: --target=x86_64-w64-mingw32 -fuse-ld=lld -rtlib=compiler-rt -unwindlib=none
      run: |
        bin\tests.exe
